## å†…å­˜åˆ†é…åŸç†

    å †æ ˆ & é€ƒé€¸åˆ†æ
    åˆ†æ®µæ ˆ & è¿ç»­æ ˆ
    å†…å­˜ç»“æ„ï¼ˆå†…å­˜ç®¡ç†ï¼‰
    ä¼˜åŒ–å®è·µ

## å †å’Œæ ˆçš„å®šä¹‰ï¼Œã€æ ˆã€‘å’Œã€å †ã€‘çš„åŒºåˆ«

Go æœ‰ä¸¤ä¸ªåœ°æ–¹å¯ä»¥åˆ†é…å†…å­˜ï¼šï¼ˆ1ï¼‰ä¸€ä¸ªå…¨å±€å †ç©ºé—´ç”¨æ¥åŠ¨æ€åˆ†é…å†…å­˜ï¼›ï¼ˆ2ï¼‰å¦ä¸€ä¸ªæ˜¯æ¯ä¸ª goroutine éƒ½æœ‰çš„è‡ªèº«æ ˆç©ºé—´ã€‚

### é€ƒé€¸åˆ†æ

â€œé€šè¿‡æ£€æŸ¥å˜é‡çš„ä½œç”¨åŸŸæ˜¯å¦è¶…å‡ºäº†å®ƒæ‰€åœ¨çš„æ ˆæ¥å†³å®šæ˜¯å¦å°†å®ƒåˆ†é…åœ¨å †ä¸Šâ€çš„æŠ€æœ¯ï¼Œå…¶ä¸­â€œå˜é‡çš„ä½œç”¨åŸŸè¶…å‡ºäº†å®ƒæ‰€åœ¨çš„æ ˆâ€è¿™ç§è¡Œä¸ºå³è¢«ç§°ä¸ºã€é€ƒé€¸ã€‘ã€‚é€ƒé€¸åˆ†æåœ¨å¤§å¤šæ•°è¯­è¨€é‡Œå±äºé™æ€åˆ†æï¼šåœ¨ç¼–è¯‘æœŸç”±é™æ€ä»£ç åˆ†ææ¥å†³å®šä¸€ä¸ªå€¼æ˜¯å¦èƒ½è¢«åˆ†é…åœ¨æ ˆå¸§ä¸Šï¼Œè¿˜æ˜¯éœ€è¦â€œé€ƒé€¸â€åˆ°å †ä¸Šã€‚


å°½å¯èƒ½è®©å˜é‡åœ¨ã€æ ˆã€‘ä¸Šï¼Œè€Œä¸æ˜¯åœ¨å †ä¸Š

Go æŸ¥æ‰¾æ‰€æœ‰å˜é‡è¶…è¿‡å½“å‰å‡½æ•°æ ˆä¾¦çš„ï¼ŒæŠŠå®ƒä»¬åˆ†é…åˆ°å †ä¸Šï¼Œé¿å… outlive å˜é‡ã€‚

ã€é€ƒé€¸æ¡ˆä¾‹ã€‘

    ä¸€ä¸ªå€¼è¢«åˆ†äº«åˆ°å‡½æ•°æ ˆå¸§èŒƒå›´ä¹‹å¤–
    åœ¨ for å¾ªç¯å¤–ç”³æ˜ï¼Œåœ¨ for å¾ªç¯å†…åˆ†é…ï¼ŒåŒç†é—­åŒ…
    å‘é€æŒ‡é’ˆæˆ–è€…å¸¦æœ‰æŒ‡é’ˆçš„å€¼åˆ° channel ä¸­
    åœ¨ä¸€ä¸ªåˆ‡ç‰‡ä¸Šå­˜å‚¨æŒ‡é’ˆæˆ–å¸¦æŒ‡é’ˆçš„å€¼
    slice çš„èƒŒåæ•°ç»„è¢«é‡æ–°åˆ†é…äº†
    åœ¨ interface ç±»å‹ä¸Šè°ƒç”¨æ–¹æ³•

go build -gcflags -m

## è¿ç»­æ ˆ

### åˆ†æ®µæ ˆ

Go åº”ç”¨ç¨‹åºè¿è¡Œæ—¶ï¼Œæ¯ä¸ª goroutine éƒ½ç»´æŠ¤ç€ä¸€ä¸ªè‡ªå·±çš„æ ˆåŒºï¼Œè¿™ä¸ªæ ˆåŒºåªèƒ½è‡ªå·±ä½¿ç”¨ä¸èƒ½è¢«å…¶ä»– goroutine ä½¿ç”¨ã€‚æ ˆåŒºçš„åˆå§‹å¤§å°æ˜¯2KBï¼Œåœ¨ goroutine è¿è¡Œçš„æ—¶å€™æ ˆåŒºä¼šæŒ‰ç…§éœ€è¦å¢é•¿å’Œæ”¶ç¼©ã€‚æ—§æ ˆé€šè¿‡æŒ‡é’ˆè¿æ¥æ–°æ ˆï¼Œæ—§æ ˆçš„å†…å®¹åŸå°ä¸åŠ¨ï¼Œæ–°æ•°æ®å­˜åˆ°æ–°æ ˆ

ã€Hot splité—®é¢˜ã€‘ï¼šå¦‚æœæ ˆå¿«æ»¡äº†ï¼Œé‚£ä¹ˆä¸‹ä¸€æ¬¡çš„å‡½æ•°è°ƒç”¨ä¼šå¼ºåˆ¶è§¦å‘æ ˆæ‰©å®¹ã€‚å½“å‡½æ•°è¿”å›æ—¶ï¼Œæ–°åˆ†é…çš„ â€œstack chunkâ€ ä¼šè¢«æ¸…ç†æ‰

### è¿ç»­æ ˆ

é‡‡ç”¨å¤åˆ¶æ ˆçš„å®ç°æ–¹å¼ï¼Œä¼šåˆ†é…ä¸€ä¸ªä¸¤å€å¤§çš„å†…å­˜å—å¹¶æŠŠè€çš„å†…å­˜å—å†…å®¹å¤åˆ¶åˆ°æ–°çš„å†…å­˜å—é‡Œã€‚

    ï¼ˆ1ï¼‰runtime.newstack åˆ†é…æ›´å¤§çš„æ ˆå†…å­˜ç©ºé—´
    ï¼ˆ2ï¼‰runtime.copystack å°†æ—§æ ˆä¸­çš„å†…å®¹å¤åˆ¶åˆ°æ–°æ ˆä¸­
    ï¼ˆ3ï¼‰å°†æŒ‡å‘æ—§æ ˆå¯¹åº”å˜é‡çš„æŒ‡é’ˆé‡æ–°æŒ‡å‘æ–°æ ˆ
    ï¼ˆ4ï¼‰runtime.stackfree é”€æ¯å¹¶å›æ”¶æ—§æ ˆçš„å†…å­˜ç©ºé—´


### æ ˆæ‰©å®¹ï¼ˆå¤æ‚ ğŸ˜… ï¼‰

Go è¿è¡Œæ—¶åˆ¤æ–­æ ˆç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼Œæ‰€ä»¥åœ¨ call function ä¸­ä¼šæ’å…¥ runtime.morestackï¼Œä½†æ¯ä¸ªå‡½æ•°è°ƒç”¨éƒ½åˆ¤å®šçš„è¯ï¼Œæˆæœ¬æ¯”è¾ƒé«˜ã€‚


## å†…å­˜ç®¡ç†ï¼ˆå¤æ‚ ğŸ˜… ï¼‰

[å›¾è§£TCMalloc](https://zhuanlan.zhihu.com/p/29216091)

Goçš„å†…å­˜ç®¡ç†æ˜¯å€Ÿé‰´äº†ã€TCMallocã€‘ï¼Œä¸»è¦è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼š

    ï¼ˆ1ï¼‰å†…å­˜ç¢ç‰‡
    ï¼ˆ2ï¼‰å¤§é”

Goçš„å†…å­˜ç®¡ç†åˆ†ä¸ºä¸‰ç±»ï¼š

    å°äº 32kb å†…å­˜åˆ†é…
    å°äº 16b å†…å­˜åˆ†é…
    å¤§äº 32kb å†…å­˜åˆ†é…

ä¸€èˆ¬å°å¯¹è±¡é€šè¿‡ mspan åˆ†é…å†…å­˜ï¼›å¤§å¯¹è±¡åˆ™ç›´æ¥ç”± mheap åˆ†é…å†…å­˜ã€‚æ ¸å¿ƒæ˜¯ï¼šã€åˆ†çº§ + å‡å°‘å¤§é”ã€‘

    Go åœ¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œä¼šå‘æ“ä½œç³»ç»Ÿç”³è¯·ä¸€å¤§å—å†…å­˜ï¼Œç”± mheap ç»“æ„å…¨å±€ç®¡ç†(ç°åœ¨ Go ç‰ˆæœ¬ ä¸éœ€è¦è¿ç»­åœ°å€äº†ï¼Œæ‰€ä»¥ä¸ä¼šç”³è¯·ä¸€å¤§å †åœ°å€)
    Go å†…å­˜ç®¡ç†çš„åŸºæœ¬å•å…ƒæ˜¯ mspanï¼Œæ¯ç§ mspan å¯ä»¥åˆ†é…ç‰¹å®šå¤§å°çš„ object
    mcache, mcentral, mheap æ˜¯ Go å†…å­˜ç®¡ç†çš„ä¸‰å¤§ç»„ä»¶ï¼Œmcache ç®¡ç†çº¿ç¨‹åœ¨æœ¬åœ°ç¼“å­˜çš„ mspanï¼›mcentral ç®¡ç†å…¨å±€çš„ mspan ä¾›æ‰€æœ‰çº¿ç¨‹


åˆ†é…å†…å­˜çš„è¿‡ç¨‹ï¼šmcache(ä¸éœ€è¦åŠ é”) -> mcentral(éœ€è¦åŠ é”) -> mheap