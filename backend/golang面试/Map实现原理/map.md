## mapå®žçŽ°åŽŸç†

    mapåº•å±‚åŽŸç†
    mapå¯ä»¥è¾¹éåŽ†è¾¹åˆ é™¤ä¹ˆ
    mapçš„åˆ é™¤è¿‡ç¨‹
    å¯ä»¥å¯¹mapå…ƒç´ å–åœ°å€ä¹ˆ
    å¦‚ä½•æ¯”è¾ƒä¸¤ä¸ªmapç›¸ç­‰
    å¦‚ä½•å®žçŽ°ä¸¤ç§getæ“ä½œ
    mapçº¿ç¨‹å®‰å…¨ä¹ˆ
    mapéåŽ†è¿‡ç¨‹ question
    mapä¸­çš„keyä¸ºä»€ä¹ˆæ˜¯æ— åºçš„
    floatç±»åž‹å¯ä»¥åšä¸ºmapçš„keyä¹ˆ
    mapèµ‹å€¼è¿‡ç¨‹ question
    mapæ‰©å®¹è¿‡ç¨‹ question question

### mapåº•å±‚åŽŸç†ï¼ˆðŸ˜ðŸ˜ðŸ˜ï¼‰

1. ä»€ä¹ˆæ˜¯map

æœ€ä¸»è¦çš„ä¸¤ç§æ•°æ®ç»“æž„ï¼šå“ˆå¸ŒæŸ¥æ‰¾è¡¨ï¼ˆHash tableï¼‰ã€æœç´¢æ ‘ï¼ˆAVLæ ‘ï¼Œçº¢é»‘æ ‘ï¼‰

å“ˆå¸ŒæŸ¥æ‰¾è¡¨è§£å†³ç¢°æ’žé—®é¢˜ï¼šå¼€æ”¾å¯»æ‰§æ³•å’Œæ‹‰é“¾æ³•

2. mapåº•å±‚å¦‚ä½•å®žçŽ°

Go è¯­è¨€é‡‡ç”¨çš„æ˜¯å“ˆå¸ŒæŸ¥æ‰¾è¡¨ï¼Œå¹¶ä¸”ä½¿ç”¨é“¾è¡¨è§£å†³å“ˆå¸Œå†²çªã€‚

- mapå†…å­˜æ¨¡åž‹

```go
// A header for a Go map.
type hmap struct {
    // å…ƒç´ ä¸ªæ•°ï¼Œè°ƒç”¨ len(map) æ—¶ï¼Œç›´æŽ¥è¿”å›žæ­¤å€¼
    count     int
    // å½“å‰mapçŠ¶æ€
    flags     uint8
    // buckets çš„å¯¹æ•° log_2
    B         uint8
    // overflow çš„ bucketï¼ˆæº¢å‡ºæ¡¶ï¼‰ è¿‘ä¼¼æ•°
    noverflow uint16
    // è®¡ç®— key çš„å“ˆå¸Œçš„æ—¶å€™ä¼šä¼ å…¥å“ˆå¸Œå‡½æ•°
    hash0     uint32
    // æŒ‡å‘ buckets æ•°ç»„ï¼Œå¤§å°ä¸º 2^B
    // å¦‚æžœå…ƒç´ ä¸ªæ•°ä¸º0ï¼Œå°±ä¸º nil
    buckets    unsafe.Pointer
    // åˆ¤æ–­æ˜¯å¦æ­£åœ¨è¿›è¡Œæ¬è¿ã€‚ æ‰©å®¹çš„æ—¶å€™ï¼Œbuckets é•¿åº¦ä¼šæ˜¯ oldbuckets çš„ä¸¤å€
    oldbuckets unsafe.Pointer
    // æŒ‡ç¤ºæ‰©å®¹è¿›åº¦ï¼Œå°äºŽæ­¤åœ°å€çš„ buckets è¿ç§»å®Œæˆ
    nevacuate  uintptr
    // æº¢å‡ºæ¡¶
    extra *mapextra // optional fields
}

type bmap struct {
    topbits  [8]uint8 // é«˜å…«ä½
    keys     [8]keytype
    values   [8]valuetype
    pad      uintptr
    overflow uintptr
}
```

hmap.buckets -> bmap -> overflow

makemapåˆå§‹åŒ–
hashå‡½æ•°ï¼Œä¸åŒçš„keyï¼Œhashåˆ°ä¸åŒçš„æ¡¶é‡Œé¢

bmap å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„â€œæ¡¶â€ï¼Œæ¡¶é‡Œé¢ä¼šæœ€å¤šè£… 8 ä¸ª keyï¼Œè¿™äº› key ä¹‹æ‰€ä»¥ä¼šè½å…¥åŒä¸€ä¸ªæ¡¶ï¼Œæ˜¯å› ä¸ºå®ƒä»¬ç»è¿‡å“ˆå¸Œè®¡ç®—åŽï¼Œå“ˆå¸Œç»“æžœæ˜¯â€œä¸€ç±»â€çš„ã€‚åœ¨æ¡¶å†…ï¼Œåˆä¼šæ ¹æ® key è®¡ç®—å‡ºæ¥çš„ hash å€¼çš„é«˜ 8 ä½æ¥å†³å®š key åˆ°åº•è½å…¥æ¡¶å†…çš„å“ªä¸ªä½ç½®ï¼ˆä¸€ä¸ªæ¡¶å†…æœ€å¤šæœ‰8ä¸ªä½ç½®ï¼‰ã€‚

æœ‰è¿™æ ·ä¸€ä¸ªç±»åž‹çš„ mapï¼šmap[int64]int8

å¦‚æžœæŒ‰ç…§ key/value/key/value/... è¿™æ ·çš„æ¨¡å¼å­˜å‚¨ï¼Œé‚£åœ¨æ¯ä¸€ä¸ª key/value å¯¹ä¹‹åŽéƒ½è¦é¢å¤– padding 7 ä¸ªå­—èŠ‚ï¼›è€Œå°†æ‰€æœ‰çš„ keyï¼Œvalue åˆ†åˆ«ç»‘å®šåˆ°ä¸€èµ·ï¼Œè¿™ç§å½¢å¼ key/key/.../value/value/...ï¼Œåˆ™åªéœ€è¦åœ¨æœ€åŽæ·»åŠ  paddingã€‚

- åˆ›å»ºmap

```go
ageMp := make(map[string]int)
// æŒ‡å®š map é•¿åº¦
ageMp := make(map[string]int, 8)

// ageMp ä¸º nilï¼Œä¸èƒ½å‘å…¶æ·»åŠ å…ƒç´ ï¼Œä¼šç›´æŽ¥panic
var ageMp map[string]int
```

- å“ˆå¸Œå‡½æ•°

é€‰æ‹© hash å‡½æ•°ä¸»è¦è€ƒå¯Ÿçš„æ˜¯ä¸¤ç‚¹ï¼šæ€§èƒ½ã€ç¢°æ’žæ¦‚çŽ‡ã€‚

### keyå®šä½è¿‡ç¨‹ï¼ˆå…ˆå®šä½bucketï¼Œå†å®šä½æ¡¶ä¸­çš„ä½ç½®ï¼‰

å®šä½æ¡¶ï¼škey ç»è¿‡å“ˆå¸Œè®¡ç®—åŽå¾—åˆ°å“ˆå¸Œå€¼ï¼Œå…± 64 ä¸ª bit ä½ï¼ˆ64ä½æœºï¼Œ32ä½æœºå°±ä¸è®¨è®ºäº†ï¼ŒçŽ°åœ¨ä¸»æµéƒ½æ˜¯64ä½æœºï¼‰ï¼Œè®¡ç®—å®ƒåˆ°åº•è¦è½åœ¨å“ªä¸ªæ¡¶æ—¶ï¼Œåªä¼šç”¨åˆ°ã€æœ€åŽBä¸ªbitä½ã€‘ã€‚è¿˜è®°å¾—å‰é¢æåˆ°è¿‡çš„ ã€Bã€‘ å—ï¼Ÿå¦‚æžœ B = 5ï¼Œé‚£ä¹ˆæ¡¶çš„æ•°é‡ï¼Œä¹Ÿå°±æ˜¯ buckets æ•°ç»„çš„é•¿åº¦æ˜¯ 2^5 = 32ã€‚

å®šä½æ¡¶ä¸­çš„ä½ç½®ï¼šå†ç”¨å“ˆå¸Œå€¼çš„ã€é«˜8ä½ã€‘ï¼Œæ‰¾åˆ°æ­¤ key åœ¨ bucket ä¸­çš„ä½ç½®ï¼Œè¿™æ˜¯åœ¨å¯»æ‰¾å·²æœ‰çš„ keyã€‚æœ€å¼€å§‹æ¡¶å†…è¿˜æ²¡æœ‰ keyï¼Œæ–°åŠ å…¥çš„ key ä¼šæ‰¾åˆ°ç¬¬ä¸€ä¸ªç©ºä½ï¼Œæ”¾å…¥ã€‚

buckets ç¼–å·å°±æ˜¯æ¡¶ç¼–å·ï¼Œå½“ä¸¤ä¸ªä¸åŒçš„ key è½åœ¨åŒä¸€ä¸ªæ¡¶ä¸­ï¼Œä¹Ÿå°±æ˜¯å‘ç”Ÿäº†å“ˆå¸Œå†²çªã€‚å†²çªçš„è§£å†³æ‰‹æ®µæ˜¯ç”¨é“¾è¡¨æ³•ï¼šåœ¨ bucket ä¸­ï¼Œä»Žå‰å¾€åŽæ‰¾åˆ°ç¬¬ä¸€ä¸ªç©ºä½ã€‚è¿™æ ·ï¼Œåœ¨æŸ¥æ‰¾æŸä¸ª key æ—¶ï¼Œå…ˆæ‰¾åˆ°å¯¹åº”çš„æ¡¶ï¼Œå†åŽ»éåŽ† bucket ä¸­çš„ keyã€‚

å¦‚æžœåœ¨ bucket ä¸­æ²¡æ‰¾åˆ°ï¼Œå¹¶ä¸” overflow ä¸ä¸ºç©ºï¼Œè¿˜è¦ç»§ç»­åŽ» overflow bucket ä¸­å¯»æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°æˆ–æ˜¯æ‰€æœ‰çš„ key æ§½ä½éƒ½æ‰¾éäº†ï¼ŒåŒ…æ‹¬æ‰€æœ‰çš„ overflow bucketã€‚

- æºç ï¼ˆquestionï¼‰

mapaccesså‡½æ•°ï¼›
hmap.flag mapçŠ¶æ€ï¼›
alg å“ˆå¸Œå‡½æ•°ï¼›
å¤–å¾ªçŽ¯éåŽ†overflowï¼Œå†…å¾ªçŽ¯éåŽ†8ä¸ªkey-valueã€‚


### mapèµ‹å€¼è¿‡ç¨‹ï¼ˆã€æ’å…¥ã€‘ã€ã€è¦†ç›–ã€‘ï¼‰ mapassignå‡½æ•° ï¼ˆquestion ðŸ˜ðŸ˜ðŸ˜ï¼‰

å¹¶å‘å†™ç›´æŽ¥æŠ¥é”™

å¯¹ key è®¡ç®— hash å€¼ï¼Œæ ¹æ® hash å€¼æŒ‰ç…§ä¹‹å‰çš„æµç¨‹ï¼Œæ‰¾åˆ°è¦èµ‹å€¼çš„ä½ç½®ï¼ˆå¯èƒ½æ˜¯æ’å…¥æ–° keyï¼Œä¹Ÿå¯èƒ½æ˜¯æ›´æ–°è€ keyï¼‰ï¼Œå¯¹ç›¸åº”ä½ç½®è¿›è¡Œèµ‹å€¼ã€‚

æ ¸å¿ƒè¿˜æ˜¯ä¸€ä¸ªåŒå±‚å¾ªçŽ¯ï¼Œå¤–å±‚éåŽ† bucket å’Œå®ƒçš„ overflow bucketï¼Œå†…å±‚éåŽ†æ•´ä¸ª bucket çš„å„ä¸ª cellã€‚


### mapå¯ä»¥è¾¹éåŽ†è¾¹åˆ é™¤ä¹ˆ

map å¹¶ä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æž„ã€‚åŒæ—¶è¯»å†™ä¸€ä¸ª map æ˜¯æœªå®šä¹‰çš„è¡Œä¸ºï¼Œå¦‚æžœè¢«æ£€æµ‹åˆ°ï¼Œä¼šç›´æŽ¥ panicã€‚

ä¸Šé¢è¯´çš„æ˜¯å‘ç”Ÿåœ¨å¤šä¸ªåç¨‹åŒæ—¶è¯»å†™åŒä¸€ä¸ª map çš„æƒ…å†µä¸‹ã€‚ å¦‚æžœåœ¨åŒä¸€ä¸ªåç¨‹å†…è¾¹éåŽ†è¾¹åˆ é™¤ï¼Œå¹¶ä¸ä¼šæ£€æµ‹åˆ°åŒæ—¶è¯»å†™ï¼Œç†è®ºä¸Šæ˜¯å¯ä»¥è¿™æ ·åšçš„ã€‚ä½†æ˜¯ï¼ŒéåŽ†çš„ç»“æžœå°±å¯èƒ½ä¸ä¼šæ˜¯ç›¸åŒçš„äº†ï¼Œæœ‰å¯èƒ½ç»“æžœéåŽ†ç»“æžœé›†ä¸­åŒ…å«äº†åˆ é™¤çš„ keyï¼Œä¹Ÿæœ‰å¯èƒ½ä¸åŒ…å«ï¼Œè¿™å–å†³äºŽåˆ é™¤ key çš„æ—¶é—´ï¼šæ˜¯åœ¨éåŽ†åˆ° key æ‰€åœ¨çš„ bucket æ—¶åˆ»å‰æˆ–è€…åŽã€‚


### mapçš„åˆ é™¤è¿‡ç¨‹ ï¼ˆquestion ðŸ˜ðŸ˜ðŸ˜ï¼‰

question ç¬¬äºŒæ­¥æ²¡çœ‹æ‡‚

1. å®ƒé¦–å…ˆä¼šæ£€æŸ¥ h.flags æ ‡å¿—ï¼Œå¦‚æžœå‘çŽ°å†™æ ‡ä½æ˜¯ 1ï¼Œç›´æŽ¥ panicï¼Œå› ä¸ºè¿™è¡¨æ˜Žæœ‰å…¶ä»–åç¨‹åŒæ—¶åœ¨è¿›è¡Œå†™æ“ä½œã€‚
2. è®¡ç®— key çš„å“ˆå¸Œï¼Œæ‰¾åˆ°è½å…¥çš„ bucketã€‚æ£€æŸ¥æ­¤ map å¦‚æžœæ­£åœ¨æ‰©å®¹çš„è¿‡ç¨‹ä¸­ï¼Œç›´æŽ¥è§¦å‘ä¸€æ¬¡æ¬è¿æ“ä½œã€‚
3. åˆ é™¤æ“ä½œåŒæ ·æ˜¯ä¸¤å±‚å¾ªçŽ¯ï¼Œæ ¸å¿ƒè¿˜æ˜¯æ‰¾åˆ° key çš„å…·ä½“ä½ç½®ã€‚å¯»æ‰¾è¿‡ç¨‹éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œåœ¨ bucket ä¸­æŒ¨ä¸ª cell å¯»æ‰¾ã€‚
4. æ‰¾åˆ°å¯¹åº”ä½ç½®åŽï¼Œå¯¹ key æˆ–è€… value è¿›è¡Œâ€œæ¸…é›¶â€æ“ä½œï¼š
5. æœ€åŽï¼Œå°† count å€¼å‡ 1ï¼Œå°†å¯¹åº”ä½ç½®çš„ tophash å€¼ç½®æˆ Emptyã€‚

### å¯ä»¥å¯¹mapå…ƒç´ å–åœ°å€ä¹ˆ

æ— æ³•å¯¹ map çš„ key æˆ– value è¿›è¡Œå–å€ã€‚

```go
func main() {
    m := make(map[string]int)
    // ./main.go:8:14: cannot take the address of m["qcrao"]
    fmt.Println(&m["qcrao"])
}
```

### å¦‚ä½•æ¯”è¾ƒä¸¤ä¸ªmapç›¸ç­‰

ç›´æŽ¥å°†ä½¿ç”¨ map1 == map2 æ˜¯é”™è¯¯çš„ã€‚è¿™ç§å†™æ³•åªèƒ½æ¯”è¾ƒ map æ˜¯å¦ä¸º nilã€‚å› æ­¤åªèƒ½æ˜¯éåŽ†map çš„æ¯ä¸ªå…ƒç´ ï¼Œæ¯”è¾ƒå…ƒç´ æ˜¯å¦éƒ½æ˜¯æ·±åº¦ç›¸ç­‰ã€‚

```go
func main() {
    var m map[string]int
    var n map[string]int

    fmt.Println(m == nil)
    fmt.Println(n == nil)

    // ä¸èƒ½é€šè¿‡ç¼–è¯‘
    //fmt.Println(m == n)
}
```

### mapçº¿ç¨‹å®‰å…¨ä¹ˆ

map ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ 

```go
if flag & hasWriting  !=0{
    throw("concurrent map write")
}
```
åœ¨æŸ¥æ‰¾ã€èµ‹å€¼ã€éåŽ†ã€åˆ é™¤çš„è¿‡ç¨‹ä¸­éƒ½ä¼šæ£€æµ‹å†™æ ‡å¿—ï¼Œä¸€æ—¦å‘çŽ°å†™æ ‡å¿—ç½®ä½ï¼ˆç­‰äºŽ1ï¼‰ï¼Œåˆ™ç›´æŽ¥ panicã€‚èµ‹å€¼å’Œåˆ é™¤å‡½æ•°åœ¨æ£€æµ‹å®Œå†™æ ‡å¿—æ˜¯å¤ä½ä¹‹åŽï¼Œå…ˆå°†å†™æ ‡å¿—ä½ç½®ä½ï¼Œæ‰ä¼šè¿›è¡Œä¹‹åŽçš„æ“ä½œã€‚

### mapéåŽ†è¿‡ç¨‹ï¼ˆquestion ðŸ˜ðŸ˜ðŸ˜ï¼‰

æœ¬æ¥ map çš„éåŽ†è¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼šéåŽ†æ‰€æœ‰çš„ bucket ä»¥åŠå®ƒåŽé¢æŒ‚çš„ overflow bucketï¼Œç„¶åŽæŒ¨ä¸ªéåŽ† bucket ä¸­çš„æ‰€æœ‰ cellã€‚æ¯ä¸ª bucket ä¸­åŒ…å« 8 ä¸ª cellï¼Œä»Žæœ‰ key çš„ cell ä¸­å–å‡º key å’Œ valueï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å®Œæˆäº†ã€‚

ä½†æ˜¯ï¼ŒçŽ°å®žå¹¶æ²¡æœ‰è¿™ä¹ˆç®€å•ã€‚è¿˜è®°å¾—å‰é¢è®²è¿‡çš„æ‰©å®¹è¿‡ç¨‹å—ï¼Ÿæ‰©å®¹è¿‡ç¨‹ä¸æ˜¯ä¸€ä¸ªåŽŸå­çš„æ“ä½œï¼Œå®ƒæ¯æ¬¡æœ€å¤šåªæ¬è¿ 2 ä¸ª bucketï¼Œæ‰€ä»¥å¦‚æžœè§¦å‘äº†æ‰©å®¹æ“ä½œï¼Œé‚£ä¹ˆåœ¨å¾ˆé•¿æ—¶é—´é‡Œï¼Œmap çš„çŠ¶æ€éƒ½æ˜¯å¤„äºŽä¸€ä¸ªä¸­é—´æ€ï¼šæœ‰äº› bucket å·²ç»æ¬è¿åˆ°æ–°å®¶ï¼Œè€Œæœ‰äº› bucket è¿˜å¾…åœ¨è€åœ°æ–¹ã€‚

å› æ­¤ï¼ŒéåŽ†å¦‚æžœå‘ç”Ÿåœ¨æ‰©å®¹çš„è¿‡ç¨‹ä¸­ï¼Œå°±ä¼šæ¶‰åŠåˆ°éåŽ†æ–°è€ bucket çš„è¿‡ç¨‹ï¼Œè¿™æ˜¯éš¾ç‚¹æ‰€åœ¨ã€‚


map éåŽ†çš„æ ¸å¿ƒåœ¨äºŽç†è§£ 2 å€æ‰©å®¹æ—¶ï¼Œè€ bucket ä¼šåˆ†è£‚åˆ° 2 ä¸ªæ–° bucket ä¸­åŽ»ã€‚è€ŒéåŽ†æ“ä½œï¼Œä¼šæŒ‰ç…§æ–° bucket çš„åºå·é¡ºåºè¿›è¡Œï¼Œç¢°åˆ°è€ bucket æœªæ¬è¿çš„æƒ…å†µæ—¶ï¼Œè¦åœ¨è€ bucket ä¸­æ‰¾åˆ°å°†æ¥è¦æ¬è¿åˆ°æ–° bucket æ¥çš„ keyã€‚

### mapä¸­çš„keyä¸ºä»€ä¹ˆæ˜¯æ— åºçš„

åœ¨éåŽ† map æ—¶ï¼Œå¹¶ä¸æ˜¯å›ºå®šåœ°ä»Ž 0 å· bucket å¼€å§‹éåŽ†ï¼Œæ¯æ¬¡éƒ½æ˜¯ä»Žä¸€ä¸ªéšæœºå€¼åºå·çš„ bucket å¼€å§‹éåŽ†ï¼Œå¹¶ä¸”æ˜¯ä»Žè¿™ä¸ª bucket çš„ä¸€ä¸ªéšæœºåºå·çš„ cell å¼€å§‹éåŽ†ã€‚è¿™æ ·ï¼Œå³ä½¿ä½ æ˜¯ä¸€ä¸ªå†™æ­»çš„ mapï¼Œä»…ä»…åªæ˜¯éåŽ†å®ƒï¼Œä¹Ÿä¸å¤ªå¯èƒ½ä¼šè¿”å›žä¸€ä¸ªå›ºå®šåºåˆ—çš„ key/value å¯¹äº†ã€‚

### floatç±»åž‹å¯ä»¥åšä¸ºmapçš„keyä¹ˆ

æœ€åŽè¯´ç»“è®ºï¼šfloat åž‹å¯ä»¥ä½œä¸º keyï¼Œä½†æ˜¯ç”±äºŽç²¾åº¦çš„é—®é¢˜ï¼Œä¼šå¯¼è‡´ä¸€äº›è¯¡å¼‚çš„é—®é¢˜ï¼Œæ…Žç”¨ä¹‹ã€‚


### mapæ‰©å®¹å’Œè¿ç§»è¿‡ç¨‹ï¼ˆ question question question ðŸ˜ðŸ˜ðŸ˜ï¼‰

ã€è£…è½½å› å­ã€‘ 
newoverflow

è§¦å‘mapæ‰©å®¹çš„æ—¶æœºï¼šåœ¨å‘ map æ’å…¥æ–° key çš„æ—¶å€™ï¼Œä¼šè¿›è¡Œæ¡ä»¶æ£€æµ‹ï¼Œç¬¦åˆä¸‹é¢è¿™ 2 ä¸ªæ¡ä»¶ï¼Œå°±ä¼šè§¦å‘æ‰©å®¹ï¼š

1. ã€è£…è½½å› å­ã€‘è¶…è¿‡é˜ˆå€¼ï¼Œæºç é‡Œå®šä¹‰çš„é˜ˆå€¼æ˜¯ 6.5ã€‚
2. overflow çš„ bucket æ•°é‡è¿‡å¤šï¼šå¤§é‡æ’å…¥åˆ é™¤ä¹‹åŽï¼Œkeyæ¯”è¾ƒç¨€ç–åˆ†æ•£

```go
// è§¦å‘æ‰©å®¹æ—¶æœº
if !h.growing() && (overLoadFactor(int64(h.count), h.B) || tooManyOverflowBuckets(h.noverflow, h.B)) {
        hashGrow(t, h)
    }

// è£…è½½å› å­è¶…è¿‡ 6.5
func overLoadFactor(count int64, B uint8) bool {
    return count >= bucketCnt && float32(count) >= loadFactor*float32((uint64(1)<<B))
}

// overflow buckets å¤ªå¤š
func tooManyOverflowBuckets(noverflow uint16, B uint8) bool {
    if B < 16 {
        return noverflow >= uint16(1)<<B
    }
    return noverflow >= 1<<15
}
```

ç¬¬ 1 ç‚¹ï¼šæˆ‘ä»¬çŸ¥é“ï¼Œæ¯ä¸ª bucket æœ‰ 8 ä¸ªç©ºä½ï¼Œåœ¨æ²¡æœ‰æº¢å‡ºï¼Œä¸”æ‰€æœ‰çš„æ¡¶éƒ½è£…æ»¡äº†çš„æƒ…å†µä¸‹ï¼Œè£…è½½å› å­ç®—å‡ºæ¥çš„ç»“æžœæ˜¯ 8ã€‚å› æ­¤å½“è£…è½½å› å­è¶…è¿‡ 6.5 æ—¶ï¼Œè¡¨æ˜Žå¾ˆå¤š bucket éƒ½å¿«è¦è£…æ»¡äº†ï¼ŒæŸ¥æ‰¾æ•ˆçŽ‡å’Œæ’å…¥æ•ˆçŽ‡éƒ½å˜ä½Žäº†ã€‚åœ¨è¿™ä¸ªæ—¶å€™è¿›è¡Œæ‰©å®¹æ˜¯æœ‰å¿…è¦çš„ã€‚

ç¬¬ 2 ç‚¹ï¼šæ˜¯å¯¹ç¬¬ 1 ç‚¹çš„è¡¥å……ã€‚å°±æ˜¯è¯´åœ¨è£…è½½å› å­æ¯”è¾ƒå°çš„æƒ…å†µä¸‹ï¼Œè¿™æ—¶å€™ map çš„æŸ¥æ‰¾å’Œæ’å…¥æ•ˆçŽ‡ä¹Ÿå¾ˆä½Žï¼Œè€Œç¬¬ 1 ç‚¹è¯†åˆ«ä¸å‡ºæ¥è¿™ç§æƒ…å†µã€‚è¡¨é¢çŽ°è±¡å°±æ˜¯è®¡ç®—è£…è½½å› å­çš„åˆ†å­æ¯”è¾ƒå°ï¼Œå³ map é‡Œå…ƒç´ æ€»æ•°å°‘ï¼Œä½†æ˜¯ bucket æ•°é‡å¤šï¼ˆçœŸå®žåˆ†é…çš„ bucket æ•°é‡å¤šï¼ŒåŒ…æ‹¬å¤§é‡çš„ overflow bucketï¼‰ã€‚

ç¬¬2ç‚¹åŽŸå› ï¼šä¸åœåœ°æ’å…¥ã€åˆ é™¤å…ƒç´ ã€‚å…ˆæ’å…¥å¾ˆå¤šå…ƒç´ ï¼Œå¯¼è‡´åˆ›å»ºäº†å¾ˆå¤š bucketï¼Œä½†æ˜¯è£…è½½å› å­è¾¾ä¸åˆ°ç¬¬ 1 ç‚¹çš„ä¸´ç•Œå€¼ï¼Œæœªè§¦å‘æ‰©å®¹æ¥ç¼“è§£è¿™ç§æƒ…å†µã€‚ä¹‹åŽï¼Œåˆ é™¤å…ƒç´ é™ä½Žå…ƒç´ æ€»æ•°é‡ï¼Œå†æ’å…¥å¾ˆå¤šå…ƒç´ ï¼Œå¯¼è‡´åˆ›å»ºå¾ˆå¤šçš„ overflow bucketï¼Œä½†å°±æ˜¯ä¸ä¼šè§¦çŠ¯ç¬¬ 1 ç‚¹çš„è§„å®šï¼Œä½ èƒ½æ‹¿æˆ‘æ€Žä¹ˆåŠžï¼Ÿoverflow bucket æ•°é‡å¤ªå¤šï¼Œå¯¼è‡´ key ä¼šå¾ˆåˆ†æ•£ï¼ŒæŸ¥æ‰¾æ’å…¥æ•ˆçŽ‡ä½Žå¾—å“äººï¼Œå› æ­¤å‡ºå°ç¬¬ 2 ç‚¹è§„å®šã€‚è¿™å°±åƒæ˜¯ä¸€åº§ç©ºåŸŽï¼Œæˆ¿å­å¾ˆå¤šï¼Œä½†æ˜¯ä½æˆ·å¾ˆå°‘ï¼Œéƒ½åˆ†æ•£äº†ï¼Œæ‰¾èµ·äººæ¥å¾ˆå›°éš¾ã€‚

å¯¹åº” ç­‰é‡æ‰©å®¹ï¼Œå¢žé‡æ‰©å®¹ ä¸¤ç§æƒ…å†µ

0105 é¢è¯•æåˆ°è¿™ä¸€ç‚¹äº†

**æ¸è¿›å¼æ‰©å®¹**ï¼Œè®¿é—®ä¸€æ¬¡ï¼ˆè®¿é—®çš„æ—¶å€™å…ˆåŽ»oldbucketsæ‰¾ï¼Œå†åŽ»bucketsä¸­æ‰¾ï¼‰ï¼Œæ¯æ¬¡è¿ç§»ä¸¤ä¸ªoldbucketsä¸­çš„key

**hashGrow() å‡½æ•°å®žé™…ä¸Šå¹¶æ²¡æœ‰çœŸæ­£åœ°â€œæ¬è¿â€ï¼Œå®ƒåªæ˜¯åˆ†é…å¥½äº†æ–°çš„ bucketsï¼Œå¹¶å°†è€çš„ buckets æŒ‚åˆ°äº† oldbuckets å­—æ®µä¸Šã€‚çœŸæ­£æ¬è¿ buckets çš„åŠ¨ä½œåœ¨ growWork() å‡½æ•°ä¸­ï¼Œè€Œè°ƒç”¨ growWork() å‡½æ•°çš„åŠ¨ä½œæ˜¯åœ¨ mapassign å’Œ mapdelete å‡½æ•°ä¸­ã€‚**ä¹Ÿå°±æ˜¯**æ’å…¥æˆ–ä¿®æ”¹ã€åˆ é™¤** key çš„æ—¶å€™ï¼Œéƒ½ä¼šå°è¯•è¿›è¡Œæ¬è¿ buckets çš„å·¥ä½œã€‚å…ˆæ£€æŸ¥ oldbuckets æ˜¯å¦æ¬è¿å®Œæ¯•ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯æ£€æŸ¥ oldbuckets æ˜¯å¦ä¸º nilã€‚

### å‚è€ƒ

[mapæºç é˜…è¯»åˆ†æž-talkgo åŒä¸€ä¸ªäºº](https://www.bilibili.com/video/BV1Q4411W7MR?from=search&seid=4495796292348114675)

[map-go-questions](https://qcrao91.gitbook.io/go/map/map-de-di-ceng-shi-xian-yuan-li-shi-shi-mo)




