## è§‚å¯Ÿè€…æ¨¡å¼

### 3.è§‚å¯Ÿè€…æ¨¡å¼æ¦‚å¿µ

    â€œè®¢é˜…è€…è®¢é˜…ä¸»é¢˜ï¼Œä¸»é¢˜é€šçŸ¥è®¢é˜…è€…â€

ä¸¤ä¸ªå¯¹è±¡

    è¢«è§‚å¯Ÿè€… -> ä¸»é¢˜
    è§‚å¯Ÿè€… -> è®¢é˜…è€…

ä¸¤ä¸ªåŠ¨ä½œ

    è®¢é˜… -> è®¢é˜…è€…è®¢é˜…ä¸»é¢˜
    é€šçŸ¥ -> ä¸»é¢˜å‘ç”Ÿå˜åŠ¨é€šçŸ¥è®¢é˜…è€…

è§‚å¯Ÿè€…æ¨¡å¼çš„ä¼˜åŠ¿ï¼š

    é«˜å†…èš -> ä¸åŒä¸šåŠ¡ä»£ç å˜åŠ¨äº’ä¸å½±å“
    å¯å¤ç”¨ -> æ–°çš„ä¸šåŠ¡(å°±æ˜¯æ–°çš„è®¢é˜…è€…)è®¢é˜…ä¸åŒæ¥å£(ä¸»é¢˜ï¼Œå°±æ˜¯è¿™é‡Œçš„æ¥å£)
    ææ˜“æ‰©å±• -> æ–°å¢æ¥å£(å°±æ˜¯æ–°å¢ä¸»é¢˜)ï¼›æ–°å¢ä¸šåŠ¡(å°±æ˜¯æ–°å¢è®¢é˜…è€…)ï¼›

### 2.ä½¿ç”¨åœºæ™¯

    æ‰€æœ‰å‘ç”Ÿå˜æ›´ï¼Œéœ€è¦é€šçŸ¥çš„ä¸šåŠ¡åœºæ™¯ï¼ˆåªè¦å‘ç”Ÿäº†æŸäº›å˜åŒ–ï¼Œéœ€è¦é€šçŸ¥ä¾èµ–äº†è¿™äº›å˜åŒ–çš„å…·ä½“äº‹ç‰©çš„ä¸šåŠ¡åœºæ™¯ã€‚ï¼‰

- æˆ‘ä»¬æœ‰å“ªäº›çœŸå®ä¸šåŠ¡åœºæ™¯å¯ä»¥ç”¨ã€Œè§‚å¯Ÿè€…æ¨¡å¼ã€å‘¢ï¼Ÿ

æ¯”å¦‚ï¼Œè®¢å•é€†å‘æµï¼Œä¹Ÿå°±æ˜¯è®¢å•æˆç«‹ä¹‹åçš„å„ç§å–æ¶ˆæ“ä½œ(ä¸è®¨è®ºå”®å)ï¼Œä¸»è¦æœ‰å¦‚ä¸‹å–æ¶ˆç±»å‹ï¼š

    æœªæ”¯ä»˜å–æ¶ˆè®¢å•
    è¶…æ—¶å…³å•
    å·²æ”¯ä»˜å–æ¶ˆè®¢å•ï¼ˆæœªç”Ÿæˆå‘è´§å•ï¼‰
    å–æ¶ˆå‘è´§å•ï¼ˆæœªå‘è´§ï¼‰
    æ‹’æ”¶

åœ¨è§¦å‘è¿™äº›å–æ¶ˆæ“ä½œéƒ½è¦è¿›è¡Œå„ç§å„æ ·çš„å­æ“ä½œï¼Œæ˜¾è€Œæ˜“è§ä¸åŒçš„å–æ¶ˆæ“ä½œæ‰€æ¶‰åŠçš„å­æ“ä½œæ˜¯å­˜åœ¨äº¤é›†çš„ã€‚å…¶æ¬¡ï¼Œå·²æ”¯ä»˜å–æ¶ˆè®¢å•çš„å­æ“ä½œåº”è¯¥æ˜¯æ‰€æœ‰è®¢å•å–æ¶ˆç±»å‹æœ€å…¨çš„ï¼Œå…¶ä»–ç±»å‹çš„å¤ç”¨ä»£ç å³å¯ï¼Œé™¤äº†åˆ†è£…æˆå‡½æ•°ç‰‡æ®µï¼Œè¿˜æœ‰ä»€ä¹ˆæ›´å¥½çš„å°è£…æ–¹å¼å—ï¼Ÿç­”æ¡ˆï¼šã€Œè§‚å¯Ÿè€…æ¨¡å¼ã€ã€‚

æ¥ç€æˆ‘ä»¬æ¥åˆ†æä¸‹è®¢å•é€†å‘æµä¸šåŠ¡ä¸­çš„å˜ä¸ä¸å˜ï¼š

å˜ï¼š

    æ–°å¢å–æ¶ˆç±»å‹
    æ–°å¢å­æ“ä½œ
    ä¿®æ”¹æŸä¸ªå­æ“ä½œçš„é€»è¾‘
    å–æ¶ˆç±»å‹å’Œå­æ“ä½œçš„å¯¹åº”å…³ç³»

ä¸å˜ï¼š

    å·²å­˜åœ¨çš„å–æ¶ˆç±»å‹
    å·²å­˜åœ¨çš„å­æ“ä½œ(åœ¨å¤–ç•Œçœ‹æ¥)

### 3.å¦‚ä½•ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼

    ä¸šåŠ¡æ¢³ç†
    ä¸šåŠ¡æµç¨‹å›¾
    ä»£ç å»ºæ¨¡
    ä»£ç 

- ä¸šåŠ¡æ¢³ç†

æ‰€æœ‰å­˜åœ¨çš„çš„é€†å‘ä¸šåŠ¡çš„å­æ“ä½œï¼š

    ä¿®æ”¹è®¢å•çŠ¶æ€
    è®°å½•è®¢å•çŠ¶æ€å˜æ›´æ—¥å¿—
    é€€ä¼˜æƒ åˆ¸
    è¿˜ä¼˜æƒ æ´»åŠ¨èµ„æ ¼
    è¿˜åº“å­˜
    è¿˜ç¤¼å“å¡
    é€€é’±åŒ…ä½™é¢
    ä¿®æ”¹å‘è´§å•çŠ¶æ€
    è®°å½•å‘è´§å•çŠ¶æ€å˜æ›´æ—¥å¿—
    ç”Ÿæˆé€€æ¬¾å•
    ç”Ÿæˆå‘ç¥¨-çº¢ç¥¨
    å‘é‚®ä»¶
    å‘çŸ­ä¿¡
    å‘å¾®ä¿¡æ¶ˆæ¯

- ä¸šåŠ¡æµç¨‹å›¾

![avatar](./è®¢å•é€†å‘æµ.png)

ç»“è®ºï¼š

    ä¸åŒçš„è®¢å•å–æ¶ˆç±»å‹çš„å­æ“ä½œå­˜åœ¨äº¤é›†ï¼Œå­æ“ä½œå¯è¢«å¤ç”¨ã€‚
    å­æ“ä½œå¯è¢«çœ‹ä½œâ€œè®¢é˜…è€…â€(ä¹Ÿå°±æ˜¯è§‚å¯Ÿè€…)
    è®¢å•å–æ¶ˆç±»å‹å¯è¢«çœ‹ä½œæ˜¯â€œä¸»é¢˜â€(ä¹Ÿå°±æ˜¯è¢«è§‚å¯Ÿè€…)
    ä¸åŒå­æ“ä½œ(â€œè®¢é˜…è€…â€)(è§‚å¯Ÿè€…)è®¢é˜…è®¢å•å–æ¶ˆç±»å‹(â€œä¸»é¢˜â€)(è¢«è§‚å¯Ÿè€…)
    è®¢å•å–æ¶ˆç±»å‹(â€œä¸»é¢˜â€)(è¢«è§‚å¯Ÿè€…)é€šçŸ¥å­æ“ä½œ(â€œè®¢é˜…è€…â€)(è§‚å¯Ÿè€…)

- ä»£ç å»ºæ¨¡

ã€Œè§‚å¯Ÿè€…æ¨¡å¼ã€çš„æ ¸å¿ƒæ˜¯ä¸¤ä¸ªæ¥å£ï¼š

ï¼ˆ1ï¼‰â€œä¸»é¢˜â€(è¢«è§‚å¯Ÿè€…)æ¥å£Observable

    æŠ½è±¡æ–¹æ³•Attach: å¢åŠ â€œè®¢é˜…è€…â€
    æŠ½è±¡æ–¹æ³•Detach: åˆ é™¤â€œè®¢é˜…è€…â€
    æŠ½è±¡æ–¹æ³•Notify: é€šçŸ¥â€œè®¢é˜…è€…â€

ï¼ˆ2ï¼‰â€œè®¢é˜…è€…â€(è§‚å¯Ÿè€…)æ¥å£ObserverInterface

    æŠ½è±¡æ–¹æ³•Do: è‡ªèº«çš„ä¸šåŠ¡

è®¢å•é€†å‘æµçš„ä¸šåŠ¡ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦å®ç°è¿™ä¸¤ä¸ªæ¥å£:

    å…·ä½“è®¢å•å–æ¶ˆçš„åŠ¨ä½œå®ç°â€œä¸»é¢˜â€æ¥å£Observable
    å­é€»è¾‘å®ç°â€œè®¢é˜…è€…â€æ¥å£ObserverInterface




ä¼ªä»£ç ï¼š


    // ------------è¿™é‡Œå®ç°ä¸€ä¸ªå…·ä½“çš„â€œä¸»é¢˜â€------------

    å…·ä½“è®¢å•å–æ¶ˆçš„åŠ¨ä½œå®ç°â€œä¸»é¢˜â€(è¢«è§‚å¯Ÿè€…)æ¥å£`Observable`ã€‚å¾—åˆ°ä¸€ä¸ªå…·ä½“çš„â€œä¸»é¢˜â€:

    - è®¢å•å–æ¶ˆçš„åŠ¨ä½œçš„â€œä¸»é¢˜â€ç»“æ„ä½“`ObservableConcrete`
        +  æˆå‘˜å±æ€§`observerList []ObserverInterface`:è®¢é˜…è€…åˆ—è¡¨
        +  å…·ä½“æ–¹æ³•`Attach`: å¢åŠ å­é€»è¾‘
        +  å…·ä½“æ–¹æ³•`Detach`: åˆ é™¤å­é€»è¾‘
        +  å…·ä½“æ–¹æ³•`Notify`: é€šçŸ¥å­é€»è¾‘

    // ------------è¿™é‡Œå®ç°æ‰€æœ‰å…·ä½“çš„â€œè®¢é˜…è€…â€------------

    å­é€»è¾‘å®ç°â€œè®¢é˜…è€…â€æ¥å£`ObserverInterface`:

    - å…·ä½“â€œè®¢é˜…è€…â€ä¹Ÿå°±æ˜¯å­é€»è¾‘`OrderStatus`
        +  å®ç°æ–¹æ³•`Do`: ä¿®æ”¹è®¢å•çŠ¶æ€
    - å…·ä½“â€œè®¢é˜…è€…â€ä¹Ÿå°±æ˜¯å­é€»è¾‘`OrderStatusLog`
        +  å®ç°æ–¹æ³•`Do`: è®°å½•è®¢å•çŠ¶æ€å˜æ›´æ—¥å¿—
    - å…·ä½“â€œè®¢é˜…è€…â€ä¹Ÿå°±æ˜¯å­é€»è¾‘`CouponRefund`
        +  å®ç°æ–¹æ³•`Do`: é€€ä¼˜æƒ åˆ¸
    - å…·ä½“â€œè®¢é˜…è€…â€ä¹Ÿå°±æ˜¯å­é€»è¾‘`PromotionRefund`
        +  å®ç°æ–¹æ³•`Do`: è¿˜ä¼˜æƒ æ´»åŠ¨èµ„æ ¼
    - å…·ä½“â€œè®¢é˜…è€…â€ä¹Ÿå°±æ˜¯å­é€»è¾‘`StockRefund`
        +  å®ç°æ–¹æ³•`Do`: è¿˜åº“å­˜
    - å…·ä½“â€œè®¢é˜…è€…â€ä¹Ÿå°±æ˜¯å­é€»è¾‘`GiftCardRefund`
        +  å®ç°æ–¹æ³•`Do`: è¿˜ç¤¼å“å¡
    - å…·ä½“â€œè®¢é˜…è€…â€ä¹Ÿå°±æ˜¯å­é€»è¾‘`WalletRefund`
        +  å®ç°æ–¹æ³•`Do`: é€€é’±åŒ…ä½™é¢
    - å…·ä½“â€œè®¢é˜…è€…â€ä¹Ÿå°±æ˜¯å­é€»è¾‘`DeliverBillStatus`
        +  å®ç°æ–¹æ³•`Do`: ä¿®æ”¹å‘è´§å•çŠ¶æ€
    - å…·ä½“â€œè®¢é˜…è€…â€ä¹Ÿå°±æ˜¯å­é€»è¾‘`DeliverBillStatusLog`
        +  å®ç°æ–¹æ³•`Do`: è®°å½•å‘è´§å•çŠ¶æ€å˜æ›´æ—¥å¿—
    - å…·ä½“â€œè®¢é˜…è€…â€ä¹Ÿå°±æ˜¯å­é€»è¾‘`Refund`
        +  å®ç°æ–¹æ³•`Do`: ç”Ÿæˆé€€æ¬¾å•
    - å…·ä½“â€œè®¢é˜…è€…â€ä¹Ÿå°±æ˜¯å­é€»è¾‘`Invoice`
        +  å®ç°æ–¹æ³•`Do`: ç”Ÿæˆå‘ç¥¨-çº¢ç¥¨
    - å…·ä½“â€œè®¢é˜…è€…â€ä¹Ÿå°±æ˜¯å­é€»è¾‘`Email`
        +  å®ç°æ–¹æ³•`Do`: å‘é‚®ä»¶
    - å…·ä½“â€œè®¢é˜…è€…â€ä¹Ÿå°±æ˜¯å­é€»è¾‘`Sms`
        +  å®ç°æ–¹æ³•`Do`: å‘çŸ­ä¿¡
    - å…·ä½“â€œè®¢é˜…è€…â€ä¹Ÿå°±æ˜¯å­é€»è¾‘`WechatNotify`
        +  å®ç°æ–¹æ³•`Do`: å‘å¾®ä¿¡æ¶ˆæ¯


```golang
// è§‚å¯Ÿè€…çš„æ¥å£
type ObserverInterface interface {
	// è‡ªèº«çš„ä¸šåŠ¡
	Do(o Observable) error
}

// è¢«è§‚å¯Ÿè€…
type Observable interface {
	Attach(observer ...ObserverInterface) Observable
	Detach(observer ObserverInterface) Observable
	Notify() error
}

// ä¸€ä¸ªå…·ä½“çš„ è®¢å•çŠ¶æ€å˜åŒ–çš„è¢«è§‚å¯Ÿè€…ï¼›ObservableConcreteå®ç°äº†Observableçš„æ‰€æœ‰æ–¹æ³•ï¼Œç»§æ‰¿Observable
//ï¼ˆquestionï¼‰ä¸ºä»€ä¹ˆä¸ç›´æ¥æŠŠobserverList æ”¾åˆ°Observableé‡Œé¢ï¼ˆğŸ˜…ï¼‰
type ObservableConcrete struct {
	observerList []ObserverInterface
}

// æ³¨å†Œè§‚å¯Ÿè€…
func (o *ObservableConcrete) Attach(observer ...ObserverInterface) Observable {
	o.observerList = append(o.observerList, observer...)
	return o
}

// æ³¨é”€è§‚å¯Ÿè€…
func (o *ObservableConcrete) Detach(observer ObserverInterface) Observable {
	if len(o.observerList) == 0 {
		return o
	}
	for k, item := range o.observerList {
		if observer == item {
			fmt.Println(runFuncName(), "æ³¨é”€:", reflect.TypeOf(observer))
			o.observerList = append(o.observerList[:k], o.observerList[k+1:]...)
		}
	}
	return o
}

// é€šçŸ¥è§‚å¯Ÿè€…
func (o *ObservableConcrete) Notify() (err error) {
	for _, observer := range o.observerList {
		if err = observer.Do(o); err != nil {
			return err
		}
	}
	return nil
}

/* å…·ä½“ä¸šåŠ¡ å®ç°äº†ObserverInterfaceè§‚å¯Ÿè€…æ¥å£  */

// ä¿®æ”¹è®¢å•çŠ¶æ€
type OrderStatus struct{}

func (os *OrderStatus) Do(o Observable) (err error) {
	fmt.Println(runFuncName(), "ä¿®æ”¹è®¢å•çŠ¶æ€...")
	return
}

// è®°å½•è®¢å•çŠ¶æ€å˜æ›´æ—¥å¿—
type OrderStatusLog struct{}

func (os *OrderStatusLog) Do(o Observable) (err error) {
	fmt.Println(runFuncName(), "è®°å½•è®¢å•çŠ¶æ€å˜æ›´æ—¥å¿—...")
	return
}

// é€€è¿˜ä¼˜æƒ åˆ¸
type CouponRefund struct{}

func (os *CouponRefund) Do(o Observable) (err error) {
	fmt.Println(runFuncName(), "é€€è¿˜ä¼˜æƒ åˆ¸...")
	return
}

// è¿”è¿˜ä¼˜æƒ æ´»åŠ¨èµ„æ ¼
type PromotionRefund struct{}

func (os *PromotionRefund) Do(o Observable) (err error) {
	fmt.Println(runFuncName(), "è¿”è¿˜ä¼˜æƒ æ´»åŠ¨èµ„æ ¼...")
	return
}

// è¿”è¿˜åº“å­˜
type StockRefund struct{}

func (os *StockRefund) Do(o Observable) (err error) {
	fmt.Println(runFuncName(), "è¿”è¿˜åº“å­˜...")
	return
}

// è¿”è¿˜ç¤¼å“å¡
type GiftCardRefund struct{}

func (os *GiftCardRefund) Do(o Observable) (err error) {
	fmt.Println(runFuncName(), "è¿”è¿˜ç¤¼å“å¡...")
	return
}

// é€€é’±åŒ…ä½™é¢
type WalletRefund struct{}

func (os *WalletRefund) Do(o Observable) (err error) {
	fmt.Println(runFuncName(), "é€€é’±åŒ…ä½™é¢...")
	return
}

// ä¿®æ”¹å‘è´§å•çŠ¶æ€
type DeliverBillStatus struct{}

func (os *DeliverBillStatus) Do(o Observable) (err error) {
	fmt.Println(runFuncName(), "ä¿®æ”¹å‘è´§å•çŠ¶æ€...")
	return
}

// è®°å½•å‘è´§å•çŠ¶æ€å˜æ›´æ—¥å¿—
type DeliverBillStatusLog struct{}

func (os *DeliverBillStatusLog) Do(o Observable) (err error) {
	fmt.Println(runFuncName(), "è®°å½•å‘è´§å•çŠ¶æ€å˜æ›´æ—¥å¿—...")
	return
}

// ç”Ÿæˆé€€æ¬¾å•
type Refund struct{}

func (os *Refund) Do(o Observable) (err error) {
	fmt.Println(runFuncName(), "ç”Ÿæˆé€€æ¬¾å•...")
	return
}

// ç”Ÿæˆå‘ç¥¨-çº¢ç¥¨
type Invoice struct{}

func (os *Invoice) Do(o Observable) (err error) {
	fmt.Println(runFuncName(), "ç”Ÿæˆå‘ç¥¨-çº¢ç¥¨...")
	return
}

// å‘é‚®ä»¶çŸ­ä¿¡å¾®ä¿¡æ¶ˆæ¯
type Message struct{}

func (os *Message) Do(o Observable) (err error) {
	fmt.Println(runFuncName(), "å‘é‚®ä»¶çŸ­ä¿¡å¾®ä¿¡æ¶ˆæ¯...")
	return
}

func main() {
	fmt.Println("=============æœªæ”¯ä»˜å–æ¶ˆè®¢å•â€œä¸»é¢˜â€=================")
	orderUnPaidCancelSubject := &ObservableConcrete{}
	orderUnPaidCancelSubject.Attach(
		&OrderStatus{},
		&OrderStatusLog{},
		&CouponRefund{},
		&PromotionRefund{},
		&StockRefund{},
	)
	orderUnPaidCancelSubject.Notify()

	fmt.Println("=============è¶…æ—¶å…³å•â€œä¸»é¢˜â€=================")
	orderOvertimeSubject := &ObservableConcrete{}
	orderOvertimeSubject.Attach(
		&OrderStatus{},
		&OrderStatusLog{},
		&CouponRefund{},
		&PromotionRefund{},
		&StockRefund{},
		&Message{},
	)
	orderOvertimeSubject.Notify()

	fmt.Println("=============å·²æ”¯ä»˜å–æ¶ˆè®¢å•â€œä¸»é¢˜â€=================")
	orderPaidCancelSubject := ObservableConcrete{}
	orderPaidCancelSubject.Attach(
		&OrderStatus{},
		&OrderStatusLog{},
		&CouponRefund{},
		&PromotionRefund{},
		&StockRefund{},
		&GiftCardRefund{},
		&WalletRefund{},
		&Refund{},
		&Invoice{},
		&Message{},
	)
	orderPaidCancelSubject.Notify()

	fmt.Println("=============å–æ¶ˆå‘è´§â€œä¸»é¢˜â€=================")
	deliverBillCancelSubject := ObservableConcrete{}
	deliverBillCancelSubject.Attach(
		&OrderStatus{},
		&OrderStatusLog{},
		&DeliverBillStatus{},
		&DeliverBillStatusLog{},
		&StockRefund{},
		&GiftCardRefund{},
		&WalletRefund{},
		&Refund{},
		&Invoice{},
		&Message{},
	)
	deliverBillCancelSubject.Notify()

	fmt.Println("=============æ‹’æ”¶â€œä¸»é¢˜â€=================")
	deliverBillRejectSubject := ObservableConcrete{}
	deliverBillRejectSubject.Attach(
		&OrderStatus{},
		&OrderStatusLog{},
		&DeliverBillStatus{},
		&DeliverBillStatusLog{},
		&StockRefund{},
		&GiftCardRefund{},
		&WalletRefund{},
		&Refund{},
		&Invoice{},
		&Message{},
	)
	deliverBillRejectSubject.Notify()
}

// è·å–æ­£åœ¨è¿è¡Œçš„å‡½æ•°å
func runFuncName() string {
	pc := make([]uintptr, 1)
	runtime.Callers(2, pc)
	f := runtime.FuncForPC(pc[0])
	return f.Name()
}
```

æœ€åæ€»ç»“ä¸‹ï¼Œã€Œè§‚å¯Ÿè€…æ¨¡å¼ã€æŠ½è±¡è¿‡ç¨‹çš„æ ¸å¿ƒæ˜¯ï¼š

	è¢«ä¾èµ–çš„â€œä¸»é¢˜â€
	è¢«é€šçŸ¥çš„â€œè®¢é˜…è€…â€
	â€œè®¢é˜…è€…â€æŒ‰éœ€è®¢é˜…â€œä¸»é¢˜â€
	â€œä¸»é¢˜â€å˜åŒ–é€šçŸ¥â€œè®¢é˜…è€…â€