## çŠ¶æ€æ¨¡å¼

### 1.ä»€ä¹ˆæ˜¯çŠ¶æ€æ¨¡å¼

    ä¸åŒçš„ç®—æ³•æŒ‰ç…§ç»Ÿä¸€çš„æ ‡å‡†å°è£…ï¼Œæ ¹æ®ä¸åŒçš„å†…éƒ¨çŠ¶æ€ï¼Œå†³ç­–ä½¿ç”¨ä½•ç§ç®—æ³•

[çŠ¶æ€æ¨¡å¼]å’Œ[ç­–ç•¥æ¨¡å¼]åŒºåˆ«

    ç­–ç•¥æ¨¡å¼ï¼šä¾é å®¢æˆ·å†³ç­–
    çŠ¶æ€æ¨¡å¼ï¼šä¾é å†…éƒ¨çŠ¶æ€å†³ç­–

### 2.ä»€ä¹ˆçœŸæ˜¯ä¸šåŠ¡åœºæ™¯å¯ä»¥ä½¿ç”¨[çŠ¶æ€æ¨¡å¼]

å…·ä½“ç®—æ³•çš„é€‰å–æ˜¯ç”±å†…éƒ¨çŠ¶æ€å†³å®šçš„

    é¦–å…ˆï¼Œå†…éƒ¨å­˜åœ¨å¤šç§çŠ¶æ€
    å…¶æ¬¡ï¼Œä¸åŒçš„çŠ¶æ€çš„ä¸šåŠ¡é€»è¾‘å„ä¸ç›¸åŒ

æ¯”å¦‚ï¼Œå‘é€çŸ­ä¿¡æ¥å£ã€é™æµç­‰ç­‰ã€‚

- çŸ­ä¿¡æ¥å£

    æœåŠ¡å†…éƒ¨æ ¹æ®æœ€ä¼˜ç®—æ³•ï¼Œå®æ—¶æ¨ä¸¾å‡ºæœ€ä¼˜çš„çŸ­ä¿¡æœåŠ¡å•†ï¼Œå¹¶ä¿®æ”¹ä½¿ç”¨ä½•ç§çŸ­ä¿¡æœåŠ¡å•†çš„çŠ¶æ€

- é™æµ

    æœåŠ¡å†…éƒ¨æ ¹æ®å½“å‰çš„å®æ—¶æµé‡ï¼Œé€‰æ‹©ä¸åŒçš„é™æµç®—æ³•ï¼Œå¹¶ä¿®æ”¹ä½¿ç”¨ä½•ç§é™æµç®—æ³•çš„çŠ¶æ€


### 3.æ€ä¹ˆä½¿ç”¨çŠ¶æ€æ¨¡å¼(ä»¥çŸ­ä¿¡éªŒè¯ç ä¸ºä¾‹)

    ä¸šåŠ¡æ¢³ç†
    ä¸šåŠ¡æµç¨‹å›¾
    ä»£ç å»ºæ¨¡
    ä»£ç 

- ä¸šåŠ¡æ¢³ç†

    å‘é€çŸ­ä¿¡ï¼Œç”¨æˆ·åªéœ€è¦è¾“å…¥æ‰‹æœºå·å³å¯
    è‡³äºçŸ­ä¿¡æœåŠ¡ä½¿ç”¨ä½•ç§çŸ­ä¿¡æœåŠ¡å•†ï¼Œæ˜¯ç”±çŸ­ä¿¡æœåŠ¡è‡ªèº«çš„å½“å‰çŸ­ä¿¡æœåŠ¡å•†å®ä¾‹çš„çŠ¶æ€å†³å®š
    å½“å‰çŸ­ä¿¡æœåŠ¡å•†å®ä¾‹çš„çŠ¶æ€åˆæ˜¯ç”±æœåŠ¡è‡ªèº«çš„ç®—æ³•ä¿®æ”¹

- ä¸šåŠ¡æµç¨‹å›¾

![avatar](./å‘é€çŸ­ä¿¡æ¥å£.png)

- ä»£ç å»ºæ¨¡

ã€ŒçŠ¶æ€æ¨¡å¼ã€çš„æ ¸å¿ƒæ˜¯ï¼š

ä¸€ä¸ªæ¥å£:

    çŸ­ä¿¡æœåŠ¡æ¥å£SmsServiceInterface

ä¸€ä¸ªå®ä½“ç±»:

    çŠ¶æ€ç®¡ç†å®ä½“ç±»StateManager


ä¼ªä»£ç å¦‚ä¸‹ï¼š

    // å®šä¹‰ä¸€ä¸ªçŸ­ä¿¡æœåŠ¡æ¥å£
    - æ¥å£`SmsServiceInterface`
        + æŠ½è±¡æ–¹æ³•`Send(ctx *Context) error`å‘é€çŸ­ä¿¡çš„æŠ½è±¡æ–¹æ³•

    // å®šä¹‰å…·ä½“çš„çŸ­ä¿¡æœåŠ¡å®ä½“ç±» å®ç°æ¥å£`SmsServiceInterface`

    - å®ä½“ç±»`ServiceProviderAliyun`
        + æˆå‘˜æ–¹æ³•`Send(ctx *Context) error`å…·ä½“çš„å‘é€çŸ­ä¿¡é€»è¾‘
    - å®ä½“ç±»`ServiceProviderTencent`
        + æˆå‘˜æ–¹æ³•`Send(ctx *Context) error`å…·ä½“çš„å‘é€çŸ­ä¿¡é€»è¾‘
    - å®ä½“ç±»`ServiceProviderYunpian`
        + æˆå‘˜æ–¹æ³•`Send(ctx *Context) error`å…·ä½“çš„å‘é€çŸ­ä¿¡é€»è¾‘

    // å®šä¹‰çŠ¶æ€ç®¡ç†å®ä½“ç±»`StateManager` (ğŸ˜…ï¼Œè¿™é‡Œä¹‹åä¸æ‡‚)
    - æˆå‘˜å±æ€§
        + `currentProviderType ProviderType`å½“å‰ä½¿ç”¨çš„æœåŠ¡æä¾›å•†ç±»å‹
        + `currentProvider SmsServiceInterface`å½“å‰ä½¿ç”¨çš„æœåŠ¡æä¾›å•†å®ä¾‹
        + `setStateDuration time.Duration`æ›´æ–°çŠ¶æ€æ—¶é—´é—´éš”
    - æˆå‘˜æ–¹æ³•
        + `initState(duration time.Duration)`åˆå§‹åŒ–çŠ¶æ€
        + `setState(t time.Time)`è®¾ç½®çŠ¶æ€


```golang
type Context struct {
	Tel        string // æ‰‹æœºå·
	Text       string // çŸ­ä¿¡å†…å®¹
	TemplateID string // çŸ­ä¿¡æ¨¡æ¿ID
}

// çŸ­ä¿¡æœåŠ¡æ¥å£
type SmsServiceInterface interface {
	Send(c *Context) error
}

// é˜¿é‡Œäº‘
type AliyunServiceProvider struct{}

func (s *AliyunServiceProvider) Send(ctx *Context) error {
	fmt.Println(runFuncName(), "ã€é˜¿é‡Œäº‘ã€‘çŸ­ä¿¡å‘é€æˆåŠŸï¼Œæ‰‹æœºå·:"+ctx.Tel)
	return nil
}

// è…¾è®¯äº‘
type TencentServiceProvider struct{}

func (s *TencentServiceProvider) Send(ctx *Context) error {
	fmt.Println(runFuncName(), "ã€è…¾è®¯äº‘ã€‘çŸ­ä¿¡å‘é€æˆåŠŸï¼Œæ‰‹æœºå·:"+ctx.Tel)
	return nil
}

// AWS
type AWSServiceProvider struct{}

func (s *AWSServiceProvider) Send(ctx *Context) error {
	fmt.Println(runFuncName(), "ã€AWSã€‘çŸ­ä¿¡å‘é€æˆåŠŸï¼Œæ‰‹æœºå·:"+ctx.Tel)
	return nil
}

// çŸ­ä¿¡æœåŠ¡æä¾›å•†ç±»å‹
type ProviderType string

const (
	ALIYUN  ProviderType = "aliyun"
	AWS     ProviderType = "aws"
	TENCENT ProviderType = "tencent"
)

var (
	// å½“å‰ä½¿ç”¨çš„æœåŠ¡æä¾›å•†å®ä¾‹
	stateManegerInstance *StateManager
)

// å®šä¹‰çŠ¶æ€ç®¡ç†å®ä½“ç±»`StateManager`
type StateManager struct {
	// å½“å‰ä½¿ç”¨çš„æœåŠ¡æä¾›å•†ç±»å‹
	currentProviderType ProviderType
	// å½“å‰ä½¿ç”¨çš„æœåŠ¡æä¾›å•†å®ä¾‹
	currentProvider SmsServiceInterface
	// æ›´æ–°çŠ¶æ€æ—¶é—´é—´éš”
	setStateDuration time.Duration
}

func (m *StateManager) initState(duration time.Duration) {
	m.setStateDuration = duration
	m.setState(time.Now())
	// å®šæ—¶æ›´æ–°çŠ¶æ€(question:è¿™é‡Œä¸æ‡‚ğŸ˜…)
	go func() {
		for {
			select {
			// æ¯ä¸€æ®µæ—¶é—´åæ ¹æ®å›è°ƒçš„å‘é€æˆåŠŸç‡ è®¡ç®—å¾—åˆ°å½“å‰åº”è¯¥ä½¿ç”¨çš„æœåŠ¡å•†
			case t := <-time.NewTicker(m.setStateDuration).C:
				m.setState(t)
			}
		}
	}()
}

// æ ¹æ®å›è°ƒçš„å‘é€æˆåŠŸç‡ è®¡ç®—å¾—åˆ°ä¸‹é˜¶æ®µåº”è¯¥ä½¿ç”¨çš„æœåŠ¡å•†
func (m *StateManager) setState(t time.Time) {
	ProviderTypeArray := [3]ProviderType{
		ALIYUN,
		TENCENT,
		AWS,
	}

	m.currentProviderType = ProviderTypeArray[rand.Intn(len(ProviderTypeArray))]

	switch m.currentProviderType {
	case ALIYUN:
		m.currentProvider = &AliyunServiceProvider{}
	case TENCENT:
		m.currentProvider = &TencentServiceProvider{}
	case AWS:
		m.currentProvider = &AWSServiceProvider{}
	default:
		panic("éæ³•çš„çŸ­ä¿¡æœåŠ¡å•†")
	}

	fmt.Printf("æ—¶é—´ï¼š%s| å˜æ›´çŸ­ä¿¡å‘é€å‚å•†ä¸º: %s \n", t.Format("2006-01-02 15:04:05"), m.currentProviderType)
}

func (m *StateManager) getState() SmsServiceInterface {
	return m.currentProvider
}

func GetState() SmsServiceInterface {
	return stateManegerInstance.getState()
}

func main() {
	// åˆå§‹åŒ–çŠ¶æ€ç®¡ç†
	stateManegerInstance = &StateManager{}
	stateManegerInstance.initState(300 * time.Millisecond)

	// æ¨¡æ‹Ÿå‘é€çŸ­ä¿¡çš„æ¥å£
	sendSms := func() {
		GetState().Send(&Context{
			Tel:        "13999999999",
			Text:       "z-mino",
			TemplateID: "mino_01",
		})
	}

	// æ¨¡æ‹Ÿç”¨æˆ·è°ƒç”¨å‘é€çŸ­ä¿¡çš„æ¥å£
	sendSms()
	time.Sleep(1 * time.Second)
	sendSms()
	time.Sleep(1 * time.Second)
	sendSms()
	time.Sleep(1 * time.Second)
	sendSms()
	time.Sleep(1 * time.Second)
	sendSms()
	time.Sleep(1 * time.Second)
	sendSms()
}

// è·å–æ­£åœ¨è¿è¡Œçš„å‡½æ•°å
func runFuncName() string {
	pc := make([]uintptr, 1)
	runtime.Callers(2, pc)
	f := runtime.FuncForPC(pc[0])
	return f.Name()
}

```