### 1.goçš„selectä½œç”¨ ï¼ˆğŸ˜… åŸç†æ¯”è¾ƒå¤æ‚ï¼‰

select æ˜¯ä¸ switch ç›¸ä¼¼çš„æ§åˆ¶ç»“æ„ï¼Œä¸ switch ä¸åŒçš„æ˜¯ï¼Œselect ä¸­è™½ç„¶ä¹Ÿæœ‰å¤šä¸ª caseï¼Œä½†æ˜¯è¿™äº› case ä¸­çš„è¡¨è¾¾å¼å¿…é¡»éƒ½æ˜¯ Channel çš„æ”¶å‘æ“ä½œ

    select èƒ½åœ¨ Channel ä¸Šè¿›è¡Œéé˜»å¡çš„æ”¶å‘æ“ä½œï¼ˆå¼‚æ­¥IOé—®é¢˜ï¼‰ï¼›
    select åœ¨é‡åˆ°å¤šä¸ª Channel åŒæ—¶å“åº”æ—¶ï¼Œä¼šã€éšæœºã€‘æ‰§è¡Œä¸€ç§æƒ…å†µï¼›



### æœªåˆå§‹åŒ–çš„channelè¯»å†™é€ æˆæ­»é”

```golang
var ch chan int
	Println(ch)
	// æœªåˆå§‹åŒ–çš„channelè¯»å†™é€ æˆæ­»é”
	// all goroutines are asleep - deadlock!
	// goroutine 1 [chan receive (nil chan)]
	// ch <- 123
	<-ch
	Println(ch)
```

### æ— ç¼“å†²channelåŒæ­¥ï¼Œæœ‰ç¼“å†²channeléåŒæ­¥

### capå‡½æ•°

arrayã€sliceã€channelåŒæ—¶åˆlenå’Œcap

### 3.goçš„deferåŸç†ï¼ˆğŸ˜… éš¾å•ƒï¼‰

- åè°ƒç”¨çš„ defer å‡½æ•°ä¼šå…ˆæ‰§è¡Œï¼ˆå…ˆè¿›åå‡ºï¼‰
- å‡½æ•°çš„å‚æ•°ä¼šè¢«é¢„å…ˆè®¡ç®—

```golang
func main() {
	for i := 0; i < 5; i++ {
		defer fmt.Println(i) // 4 3 2 1 0
	}
}
// defer ä¼ å…¥çš„å‡½æ•°ä¸æ˜¯åœ¨é€€å‡ºä»£ç å—çš„ä½œç”¨åŸŸæ—¶æ‰§è¡Œçš„ï¼Œå®ƒåªä¼šåœ¨å½“å‰å‡½æ•°å’Œæ–¹æ³•è¿”å›ä¹‹å‰è¢«è°ƒç”¨
func main() {
    {
        defer fmt.Println("defer runs")
        fmt.Println("block ends")
    }
    
    fmt.Println("main ends")
}
// resultï¼š
// block ends
// main ends
// defer runs

// Go è¯­è¨€ä¸­æ‰€æœ‰çš„å‡½æ•°è°ƒç”¨éƒ½æ˜¯ä¼ å€¼çš„ï¼Œè™½ç„¶ defer æ˜¯å…³é”®å­—ï¼Œä½†æ˜¯ä¹Ÿç»§æ‰¿äº†è¿™ä¸ªç‰¹æ€§
func main() {
	startedAt := time.Now()
	defer fmt.Println(time.Since(startedAt))
	
	time.Sleep(time.Second)
}

// è™½ç„¶è°ƒç”¨ defer å…³é”®å­—æ—¶ä¹Ÿä½¿ç”¨å€¼ä¼ é€’ï¼Œä½†æ˜¯å› ä¸ºæ‹·è´çš„æ˜¯å‡½æ•°æŒ‡é’ˆ
func main() {
	startedAt := time.Now()
	defer func() { fmt.Println(time.Since(startedAt)) }()
	
	time.Sleep(time.Second)
}
```

### deferè¿è¡Œ

```golang
type Slice []int

func NewSlice() Slice {
	return make(Slice, 0)
}

func (s *Slice) Add(num int) *Slice {
	*s = append(*s, num)
	return s
}

func handle1(s *Slice) {
	// è¿è¡Œç»“æœï¼š132
	// ğŸ”¥ğŸ”¥ğŸ”¥  å…ˆè®¡ç®—æœ€åä¸€ä¸ªAPIä¸»è¯­çš„å€¼
	defer s.Add(1).Add(2)
	s.Add(3)
}
func handle2(s *Slice) {
	// è¿è¡Œç»“æœï¼š312
	defer func() {
		defer s.Add(1).Add(2)
	}()
	s.Add(3)
}
func main() {
	s1 := NewSlice()
	handle1(&s1)
    Println(s1)
    
	s2 := NewSlice()
	handle2(&s2)
	Println(s2)
}
```

```golang
func calc(index string, a, b int) int {
	res := a + b
	Println(index, a, b, res)
	return res
}
func main() {
	a, b := 1, 2
	// å‡½æ•°çš„å‚æ•°ä¼šè¢«é¢„å…ˆè®¡ç®—
	defer calc("1", a, calc("10", a, b))
	a = 0
	defer calc("2", a, calc("20", a, b))
	b = 1
	// å‡½æ•°å‚æ•°ä¸ä¼šé¢„å…ˆè®¡ç®—
	// defer func() {
	// 	calc("1", a, calc("10", a, b))
	// }()
}
```

### å¹¶å‘å®‰å…¨

```golang
type UserAges struct {
	ages       map[string]int
	sync.Mutex // ç»§æ‰¿é”
}

func (ua *UserAges) Add(name string, age int) {
	ua.Lock()
	defer ua.Unlock()
	ua.ages[name] = age
}

// å¹¶å‘å®‰å…¨é—®é¢˜
func (ua *UserAges) Get(name string) int {
	a.Lock()
	defer ua.Unlock()
	if age, ok := ua.ages[name]; ok {
		return age
	}
	return -1
}
func main() {
	ua := UserAges{ages: make(map[string]int)}
	//  ğŸ”¥ğŸ”¥ğŸ”¥  ç­‰å¾…ä¸»åç¨‹ä¸­åˆ›å»ºçš„åç¨‹æ‰§è¡Œå®Œæ¯•ä¹‹åå†ç»“æŸä¸»åç¨‹ï¼ˆæˆ–è€…ç”¨channelä¹Ÿå¯ä»¥ï¼Œsleepä¹Ÿè¡Œï¼‰
	var wg sync.WaitGroup
	wg.Add(20)
	for i := 0; i < 19; i++ {
		go func() {
			age := ua.Get("ä½ å¥½")
			Println(age)
			wg.Done()
		}()
	}
	go func() {
		ua.Add("ä½ å¥½", 18)
		wg.Done()
	}()
	wg.Wait()
}
```


### defer return é—®é¢˜(question)

```golang
func main() {

	Println(DeferFunc1(1))
	Println(DeferFunc2(1))
	Println(DeferFunc3(1))
}

// å‡½æ•°è¿”å›å€¼åå­—ä¼šåœ¨å‡½æ•°èµ·å§‹å¤„è¢«åˆå§‹åŒ–ä¸ºå¯¹åº”ç±»å‹çš„é›¶å€¼å¹¶ä¸”ä½œç”¨åŸŸä¸ºæ•´ä¸ªå‡½æ•° DeferFunc1æœ‰å‡½æ•°è¿”å›å€¼tä½œç”¨åŸŸä¸ºæ•´ä¸ªå‡½æ•°ï¼ˆå…¨å±€å˜é‡ï¼‰ï¼Œ
// åœ¨returnä¹‹å‰deferä¼šè¢«æ‰§è¡Œï¼Œæ‰€ä»¥tä¼šè¢«ä¿®æ”¹ï¼Œè¿”å› 4
func DeferFunc1(i int) (t int) {
	t = i
	// éœ€è¦æ˜ç¡®ä¸€ç‚¹æ˜¯deferéœ€è¦åœ¨å‡½æ•°ç»“æŸå‰æ‰§è¡Œ
	defer func() {
		t += 3
	}()
	return t
}

// ä¸ºå•¥ğŸ˜… ğŸ˜… ğŸ˜… å‡½æ•°ä¸­tçš„ä½œç”¨åŸŸä¸ºå‡½æ•°ï¼ˆå±€éƒ¨å˜é‡ï¼Œä¼šé”€æ¯ï¼‰ï¼Œè¿”å› 1
func DeferFunc2(i int) int {
	t := i
	defer func() {
		t += 3
	}()
	return t
}

// è¿”å› 3ï¼Œå’ŒDeferFunc1ä¸€ä¸ªé“ç†
func DeferFunc3(i int) (t int) {
	defer func() {
		t += i
	}()
	return 2
}
```

### å¤šä¸ªpanicé—®é¢˜

```golang
func main() {
	// ä¸€ä¸ªå‡½æ•°å†…å¤šä¸ªpanicï¼Œä»¥æœ€åä¸€ä¸ªä¸ºå‡†
	defer func() {
		if err := recover(); err != nil {
			Println(err)
		} else {
			Println("fatal")
		}
	}()
	defer func() {
		panic("defer panic")
	}()
	panic("panic")
}
```