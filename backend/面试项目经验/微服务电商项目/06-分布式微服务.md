### 超时机制（请求超时，【订单超时】）

【先扣库存】 or 【后扣库存】，都有会问题，库存扣减和订单表不一致问题

支付超时问题：（1）支付成功之后再扣库存；（2）建订单的时候扣库存

## MySQL事务（ACID 🔥🔥🔥）

    （1）失败后，退回到开始的位置
    （2）没成功之前，其他用户（进程会话）无法看到操作内的数据修改


【原子性】（Atomicity）：关注状态。

【一致性】（Consistency）：关注可见性，数据中间状态（过渡状态）对其他事务不可见

【隔离性】（Isolation）：不能互相干扰

【持久性】（Durability）

【MySQL的隔离级别】：读未提交、读已提交、可重复读、串行化


### 程序运行过程中的那些问题会导致一致性问题

网络错误（网络拥塞，网络抖动）：超时机制，重试机制


## CAP和BASE理论（🔥🔥🔥）

### CAP（三个特性只能满足两个）

【一致性】（Consistency）、【可用性】（Availability）、【分区容错性】（Partition Tolerance）

一致性和可用性互斥？

### BASE（CAP理论的一种权衡的结果）：【基本可用】、【软状态】，【最终一致】

弱一致性、强一致性

允许损失部分可用性：响应时间上的损失、性能上的损失


## 分布式事务解决方案（🔥🔥🔥）

    两阶段提交
    TCC补偿模式
    基于本地消息表实现最终一致性
    基于可靠消息最终一致性方案
    最大努力通知

【两阶段提交（2PC）】：利用数据库事务特性。有性能问题，类似于【全局大锁】；单节点故障

【TCC补偿模式】：Try/Confirm/Cancel；业务端加锁，对业务逻辑侵入性太强

【基于本地消息表实现最终一致性】：本地【MQ队列】；消息不可靠，定时扫描日志，消息重复发送问题

【基于可靠消息最终一致性方案】：消息+事务（基于事务消息），half消息；本地发送出去的消息是可靠的；事务消息回查

【最大努力通知】：支付成功之后努力通知商户。重试策略，阶梯增长时间尝试 + 最大次数限制；提供查询接口；消息和通知由MQ实现


## 消息队列

MQ所面临的问题：【重复消费】、【消息丢失】、【顺序传递】、【一致性问题】

### rocketmq基本概念

    Producer：生产者，消息的发送者
    Consumer：消费者，消息接受者
    Broker：暂存和传输消息
    NameServer：管理Broker
    Topic：区分消息的种类，Topic和Producer、Consumer都可以是一对多
    MessageQueue：Topic中的分区


### rocketmq消息类型

按照发送的特点：

    同步发送、异步发送、单向发送

按照使用功能特点：

    普通消息（无序）
    顺序消息
    延时消息（ 😅 订单超时库存归还，类似于定时器执行定时任务）
    事务消息（😅😅😅，回查消息）


### 基于可靠消息最终一致性的事务解决【库存归还】；订单超时库存归还（延时消息）；订单成功之后发送延时消息，延时消息监听

question 各种幺蛾子（🔥🔥🔥🔥🔥🔥）

    （1）扣减库存之前，先发送一个half事务消息，回调函数check_callback,local_execute
    （2）什么时候应该对事务消息进行确认？什么时候commit，什么时候rollback
    （3）消息回查
    （4）监听rocketmq对应topic，启用消费者，订阅topic

**【下单，支付，超时，库存归还】**


### 服务雪崩 & 超时 & 重试 & 幂等性 （🔥🔥🔥）

【服务雪崩】：服务不可用逐渐放大的现象。

【超时机制】、【重试机制】

**【幂等性】**（post、put操作）：【唯一索性】、【token机制】、【悲观锁】、【乐观锁】、【分布式锁】、【select+insert】、【source源+seq序列】

**请求多久超时？重试几次？**

【grpc_retry】


### 链路追踪（😅）

链路追踪：排查错误、排查接口响应慢

链路追踪技术选型：jeager

【grpc继承jeager】

【链路的起点】；jeagerMiddleware：在【拦截器】中注入链路追踪，避免代码入侵

【负载均衡中】加入链路追踪

### 限流 & 熔断 & 降级（🔥）

【服务雪崩】的原因：大请求，用户重试等

应对【服务雪崩】策略：应用扩容，流控，缓存，服务降级，服务熔断

【熔断&限流】技术选型：sentinel。

限流：【基于qps】。【预热和冷启动 🔥】（WarmUp），缓慢启动。【匀速通过】

熔断降级【close，open，half open】：【慢调用比例】，【错误比例】，【错误计数】，【静默数】

### API网关 & 部署（Jenkins）

【API网关 😅 】：统一配置，流量管理（黑白名单，反爬），负载均衡，动态路由，限流管理，服务发现，熔断降级

【OpenResty】，【nginx+Lua模块】