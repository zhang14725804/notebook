## 阿里云OSS（对象存储服务）

可参考【Go实战仿百度云盘】课程

出于安全考虑：使用子账户控制传输

1. 【前端-->后端-->OSS】上传模式，涉及两次文件传输

2. 【前端直穿OSS】上传模式，前端请求后端，后端返回签名，前端带着签名和文件一起上传给OSS；还有一种【回调模式】，用来处理上传成功之后后端逻辑；需要配置CORS


## 库存服务（😅）

【多个仓库、涉及进销存、支付成功/失败之后库存问题】

设置库存，预扣库存，归还库存（超时），确认扣减库存（支付成功）

### 库存服务表结构（【仓库表】+【商品库存表】+【扣减库存表】）

涉及【批量操作】
    
- 设置库存接口（同一个接口既可以create创建，也可以update更新 😅）

- 扣减库存（查看库存是否足够，）

涉及【MySQL事务 😅😅😅】，事务执行失败需要【事务回滚】，事务必须要在【同一个连接】中才有效，涉及资源竞争【锁】操作

- 库存归还（订单超时、创建订单失败、取消订单（手动归还））


### 分布式锁（ 😅😅😅 多线程并发导致数据不一致问题）

【超卖问题】

【常见的分布式锁的实现方案】

（1）基于MySQL：（1）悲观锁（锁表，并发不友好）；（2）乐观锁（原子操作代替锁 😅：尝试去做，不行了重来就好了）

（2）基于redis： 设置key，然后根据key判断是否可以操作，类似于设置全局flag，根据flag判断。

基于redis的问题（😅😅😅😅）：

    怎么保证原子操作（互斥性）：【redis的setnx命令】
    安全性（逻辑出错导致无法释放锁）、死锁（永久占有问题）：设置过期时间（expireTime）；
    锁只能被持有的用户删除，无法被其他人删除：加uuid判断是否是同一个用户；获取/对比uuid/删除，三个步骤也需要原子操作（lua脚本保证原子操作😅）
    过期时间导致的问题：当前程序未执行完，时间却过期了（如何续租问题😅）


（3）基于zookeepr的分布式锁