### 超时机制（请求超时，【订单超时】）

【先扣库存】 or 【后扣库存】，都有会问题，库存扣减和订单表不一致问题

支付超时问题：（1）支付成功之后再扣库存；（2）建订单的时候扣库存

## MySQL事务（ACID 🔥🔥🔥）

    （1）失败后，退回到开始的位置
    （2）没成功之前，其他用户（进程会话）无法看到操作内的数据修改


【原子性】（Atomicity）：关注状态。

【一致性】（Consistency）：关注可见性，数据中间状态（过渡状态）对其他事务不可见

【隔离性】（Isolation）：不能互相干扰

【持久性】（Durability）

【MySQL的隔离级别】：读未提交、读已提交、可重复读、串行化


### 程序运行过程中的那些问题会导致一致性问题

网络错误（网络拥塞，网络抖动）：超时机制，重试机制


## CAP和BASE理论（🔥🔥🔥）

### CAP（三个特性只能满足两个）

【一致性】（Consistency）、【可用性】（Availability）、【分区容错性】（Partition Tolerance）

一致性和可用性互斥？

### BASE（CAP理论的一种权衡的结果）：【基本可用】、【软状态】，【最终一致】

弱一致性、强一致性

允许损失部分可用性：响应时间上的损失、性能上的损失


## 分布式事务解决方案（🔥🔥🔥）

    两阶段提交
    TCC补偿模式
    基于本地消息表实现最终一致性
    基于可靠消息最终一致性方案
    最大努力通知

【两阶段提交（2PC）】：利用数据库事务特性。有性能问题，类似于【全局大锁】；单节点故障

【TCC补偿模式】：Try/Confirm/Cancel；业务端加锁，对业务逻辑侵入性太强

【基于本地消息表实现最终一致性】：本地【MQ队列】；消息不可靠，定时扫描日志，消息重复发送问题

【基于可靠消息最终一致性方案】：消息+事务（基于事务消息）；本地发送出去的消息是可靠的；事务消息回查

【最大努力通知】：支付成功之后努力通知商户。重试策略，阶梯增长时间尝试 + 最大次数限制；提供查询接口；消息和通知由MQ实现