## sync.Mapæºç å®ç°

### å¹¶å‘å†™mapä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ

```golang
// fatal error: concurrent map writes
func main() {
	m := map[int]int{1: 1}
	go do(m)
	go do(m)

	time.Sleep(1 * time.Second)
	fmt.Println(m)
}

func do(m map[int]int) {
	i := 0
	for i < 10000 {
		m[1] = 1
		i++
	}
}
```
### RWMutex + map

```golang
var s sync.RWMutex

func main() {
	m := map[int]int{1: 1}
	go do(m)
	go do(m)

	time.Sleep(1 * time.Second)
	fmt.Println(m)
}

func do(m map[int]int) {
	i := 0
	for i < 10000 {
		// åŠ é”
		s.Lock()
		m[1] = 1
		// è§£é”
		s.Unlock()
		i++
	}
}
```

### sync.Map

```golang
func main() {
	// sync.Map
	m := sync.Map{}
	m.Store(1, 1)
	go do(m)
	go do(m)

	time.Sleep(1 * time.Second)
	fmt.Println(m.Load(1))
}

func do(m sync.Map) {
	i := 0
	for i < 10000 {
		m.Store(1, 1)
		i++
	}
}
```

### sync.Mapæºç å®ç°(ğŸ˜…ğŸ˜…ğŸ˜…)

**å†™ï¼šç›´å†™ã€‚ è¯»ï¼šå…ˆè¯»readï¼Œæ²¡æœ‰å†è¯»dirtyã€‚**

sync.Mapçš„å®ç°æœ‰å‡ ä¸ªä¼˜åŒ–ç‚¹ï¼š

    ç©ºé—´æ¢æ—¶é—´ã€‚ é€šè¿‡å†—ä½™çš„ä¸¤ä¸ªæ•°æ®ç»“æ„(readã€dirty),å®ç°åŠ é”å¯¹æ€§èƒ½çš„å½±å“ã€‚
    ä½¿ç”¨åªè¯»æ•°æ®(read)ï¼Œé¿å…è¯»å†™å†²çªã€‚
    åŠ¨æ€è°ƒæ•´ï¼Œmissæ¬¡æ•°å¤šäº†ä¹‹åï¼Œå°†dirtyæ•°æ®æå‡ä¸ºreadã€‚
    double-checkingã€‚
    å»¶è¿Ÿåˆ é™¤ã€‚ åˆ é™¤ä¸€ä¸ªé”®å€¼åªæ˜¯æ‰“æ ‡è®°ï¼Œåªæœ‰åœ¨æå‡dirtyçš„æ—¶å€™æ‰æ¸…ç†åˆ é™¤çš„æ•°æ®ã€‚
    ä¼˜å…ˆä»readè¯»å–ã€æ›´æ–°ã€åˆ é™¤ï¼Œå› ä¸ºå¯¹readçš„è¯»å–ä¸éœ€è¦é”ã€‚

```golang
type Map struct {
	// å½“æ¶‰åŠåˆ°dirtyæ•°æ®çš„æ“ä½œçš„æ—¶å€™ï¼Œéœ€è¦ä½¿ç”¨è¿™ä¸ªé”
	mu Mutex
	// ä¸€ä¸ªåªè¯»çš„æ•°æ®ç»“æ„ï¼Œå› ä¸ºåªè¯»ï¼Œæ‰€ä»¥ä¸ä¼šæœ‰è¯»å†™å†²çªã€‚
	// æ‰€ä»¥ä»è¿™ä¸ªæ•°æ®ä¸­è¯»å–æ€»æ˜¯å®‰å…¨çš„ã€‚
	// å®é™…ä¸Šï¼Œå®é™…ä¹Ÿä¼šæ›´æ–°è¿™ä¸ªæ•°æ®çš„entries,å¦‚æœentryæ˜¯æœªåˆ é™¤çš„(unexpunged), å¹¶ä¸éœ€è¦åŠ é”ã€‚å¦‚æœentryå·²ç»è¢«åˆ é™¤äº†ï¼Œéœ€è¦åŠ é”ï¼Œä»¥ä¾¿æ›´æ–°dirtyæ•°æ®ã€‚
	read atomic.Value // readOnly
	// dirtyæ•°æ®åŒ…å«å½“å‰çš„mapåŒ…å«çš„entries,å®ƒåŒ…å«æœ€æ–°çš„entries(åŒ…æ‹¬readä¸­æœªåˆ é™¤çš„æ•°æ®,è™½æœ‰å†—ä½™ï¼Œä½†æ˜¯æå‡dirtyå­—æ®µä¸ºreadçš„æ—¶å€™éå¸¸å¿«ï¼Œä¸ç”¨ä¸€ä¸ªä¸€ä¸ªçš„å¤åˆ¶ï¼Œè€Œæ˜¯ç›´æ¥å°†è¿™ä¸ªæ•°æ®ç»“æ„ä½œä¸ºreadå­—æ®µçš„ä¸€éƒ¨åˆ†),æœ‰äº›æ•°æ®è¿˜å¯èƒ½æ²¡æœ‰ç§»åŠ¨åˆ°readå­—æ®µä¸­ã€‚
	// å¯¹äºdirtyçš„æ“ä½œéœ€è¦åŠ é”ï¼Œå› ä¸ºå¯¹å®ƒçš„æ“ä½œå¯èƒ½ä¼šæœ‰è¯»å†™ç«äº‰ã€‚
	// å½“dirtyä¸ºç©ºçš„æ—¶å€™ï¼Œ æ¯”å¦‚åˆå§‹åŒ–æˆ–è€…åˆšæå‡å®Œï¼Œä¸‹ä¸€æ¬¡çš„å†™æ“ä½œä¼šå¤åˆ¶readå­—æ®µä¸­æœªåˆ é™¤çš„æ•°æ®åˆ°è¿™ä¸ªæ•°æ®ä¸­ã€‚
	dirty map[interface{}]*entry
	// å½“ä»Mapä¸­è¯»å–entryçš„æ—¶å€™ï¼Œå¦‚æœreadä¸­ä¸åŒ…å«è¿™ä¸ªentry,ä¼šå°è¯•ä»dirtyä¸­è¯»å–ï¼Œè¿™ä¸ªæ—¶å€™ä¼šå°†missesåŠ ä¸€ï¼Œ
	// å½“missesç´¯ç§¯åˆ° dirtyçš„é•¿åº¦çš„æ—¶å€™ï¼Œ å°±ä¼šå°†dirtyæå‡ä¸ºread,é¿å…ä»dirtyä¸­misså¤ªå¤šæ¬¡ã€‚å› ä¸ºæ“ä½œdirtyéœ€è¦åŠ é”ã€‚
	misses int
}

type readOnly struct {
	m       map[interface{}]*entry
	amended bool // Map.dirtyçš„æ•°æ®å’Œè¿™é‡Œçš„ m ä¸­çš„æ•°æ®ä¸ä¸€æ ·çš„æ—¶å€™ï¼Œä¸ºtrue
}

type entry struct {
    // å¯è§valueæ˜¯ä¸ªæŒ‡é’ˆç±»å‹ï¼Œè™½ç„¶readå’Œdirtyå­˜åœ¨å†—ä½™æƒ…å†µï¼ˆamended=falseï¼‰ï¼Œä½†æ˜¯ç”±äºæ˜¯æŒ‡é’ˆç±»å‹ï¼Œå­˜å‚¨çš„ç©ºé—´åº”è¯¥ä¸æ˜¯é—®é¢˜
    p unsafe.Pointer // *interface{}
}

```

### å»¶ç”³

mysqlåŠ é”ï¼Œæ˜¯ä¸æ˜¯æœ‰è¡¨çº§é”ã€è¡Œçº§é”ã€‚sync.RWMutexåŠ é”æ–¹å¼ç›¸å½“äºè¡¨çº§é”ã€‚è€Œsync.Mapå…¶å®ä¹Ÿæ˜¯ç›¸å½“äºè¡¨çº§é”ï¼Œåªä¸è¿‡å¤šè¯»å†™åˆ†äº†ä¸¤ä¸ªmapï¼Œæœ¬è´¨è¿˜æ˜¯ä¸€æ ·çš„ã€‚

æ—¢ç„¶è¿™æ ·ï¼Œé‚£å°±è‡ªç„¶çŸ¥é“ä¼˜åŒ–æ–¹å‘äº†ï¼šå°±æ˜¯æŠŠé”çš„ç²’åº¦å°½å¯èƒ½é™ä½æ¥æé«˜è¿è¡Œé€Ÿåº¦ã€‚

æ€è·¯ï¼šå¯¹ä¸€ä¸ªå¤§mapè¿›è¡Œhashï¼Œå…¶å†…éƒ¨æ˜¯nä¸ªå°mapï¼Œæ ¹æ®keyæ¥æ¥hashç¡®å®šåœ¨å…·ä½“çš„é‚£ä¸ªå°mapä¸­ï¼Œè¿™æ ·åŠ é”çš„ç²’åº¦å°±å˜æˆ1/näº†


### å‚è€ƒ

[Go 1.9 sync.Mapæ­ç§˜](https://colobu.com/2017/07/11/dive-into-sync-Map/)

[ç”±æµ…å…¥æ·±Golangçš„sync.Map](https://juejin.cn/post/6844903895227957262)



