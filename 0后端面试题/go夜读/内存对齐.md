## å†…å­˜å¯¹é½

æ•°ç»„çš„å¯¹é½æ–¹å¼ï¼Œå’Œå…ƒç´ ç±»å‹ç›¸å…³

### 1.æ•°æ®ç»“æ„å¯¹å…¶

ï¼ˆ1ï¼‰ final zero fieldé—®é¢˜
```golang
type T1 struct {
	a int64
	b struct{} // final zero fieldé—®é¢˜
}
// ä¸€èˆ¬é‡‡ç”¨å¦‚ä¸‹æ–¹å¼
type T2 struct {
	b struct{}
	a int64
}

func main() {
	a1 := T1{}
	a2 := T2{}
	fmt.Printf("T1=%d,T2=%d", unsafe.Sizeof(a1), unsafe.Sizeof(a2)) // T1=16,T2=8
}
```
ï¼ˆ2ï¼‰é‡æ’ä¼˜åŒ–(ä»å¤§åˆ°å°)

```golang
// æŒ‰ç…§å¯¹å…¶çš„é€’å‡æ¥é‡æ’ï¼ˆstructlayoutã€malignedå·¥å…·ï¼‰
type tooMuchPadding struct {
	i64 int64
	ptr *string
	i32 int32
	i16 int16
	i8  int8
	b   bool
}
```

### 2.å†…å­˜åœ°å€å¯¹é½

```golang
    // åˆ¤æ–­æ˜¯å¦æ˜¯åœ°å€å¯¹é½ï¼Ÿ
    uintptr(unsafe.Pointer(&x)) % unsafe.Alignof(x) == 0

    // ä¸€ä¸ªä¾‹å­ ä¸æ‡‚ï¼ˆğŸ˜…ï¼‰
    type WaitGroup struct{
        noCopy noCopy
        state1 [3]uint32 // ä¸ºä»€ä¹ˆæ˜¯[3]uint32ï¼Œè€Œä¸æ˜¯[12]byte
    }
```

### 3.64ä½å­—çš„å®‰å…¨è®¿é—®ä¿è¯ï¼ˆwhyï¼Œhowï¼‰

å˜é‡æˆ–å·²åˆ†é…(newæˆ–è€…make)çš„ç»“æ„ä½“ã€æ•°ç»„æˆ–åˆ‡ç‰‡ä¸­çš„ç¬¬ä¸€ä¸ªå­—å¯ä»¥ä¾èµ–å½“ä½œæ˜¯64ä½å¯¹é½ï¼ˆç»•å£ä»¤ä¸€æ · ğŸ˜…ï¼‰

```golang
// 32ä½å­—ä¼šå‡ºé—®é¢˜ï¼Ÿ
type WillPanic struct{
    init bool
    cuncounted int64
}

// å¦‚ä½•ä¿è¯64ä½å­—çš„å®‰å…¨è®¿é—®

// case1
var c0 int64
fmt.Println("64ä½å­—æœ¬èº«ï¼š", atomic.AddInt64(&c0, 1))
// case2
c1 := [5]int64{}
fmt.Println("64ä½å­—æ•°ç»„åˆ‡ç‰‡ï¼š", atomic.AddInt64(&c1[:][0], 1))
// case3
c2 := struct {
    val   int64
    val2  int64
    valid bool
}{}
fmt.Println("ç»“æ„ä½“å—å­—æ®µä½å¯¹å…¶çš„64ä½å­—åŠç›¸é‚»çš„64ä½å­—ï¼š", atomic.AddInt64(&c2.val, 1), atomic.AddInt64(&c2.val2, 1))
// case4
type T struct {
	val12 int64
	_     int16
}

func main() {
	c3 := struct {
		val   T
		valid bool
	}{}
	fmt.Println("ç»“æ„ä½“ä¸­é¦–å­—æ®µä½åµŒå¥—ç»“æ„ä½“ï¼Œä¸”å…¶é¦–å…ƒç´ ä¸º64ä½å­—:",atomic.AddInt64(&c3.val.val12, 1))
}
// case5
c4 := struct {
    val   int64
    valid bool
    _     [4]byte // æˆ–è€… _ uint32
    val2  int64
}{}

fmt.Println("ç»“æ„ä½“å¢åŠ å¡«å……æ˜¯å¯¹é½çš„64ä½å­—ï¼š", atomic.AddInt64(&c4.val2, 1))
// case6
// æ³¨æ„å¿…é¡»æ˜¯ã€åˆ‡ç‰‡ã€‘ï¼Œä¸èƒ½æ˜¯æ•°ç»„
c5 := struct {
    val   int64
    valid bool
    val12 []int64
}{val12: []int64{0}}
fmt.Println("ç»“æ„ä½“ä¸­64ä½å­—ã€åˆ‡ç‰‡ã€‘ï¼š", atomic.AddInt64(&c5.val12[0], 1))

c6 := struct {
    val   int64
    valid bool
    val2  *int64
}{val2: new(int64)}
fmt.Println("ç»“æ„ä½“ä¸­64ä½å­—æŒ‡é’ˆï¼š", atomic.AddInt64(c6.val2, 1))

// case7
// åŠ é”æ“ä½œï¼ˆsync.Mutexï¼‰
```

**å¦‚æœåŒ…å«é¦–ä¸ª64ä½å­—çš„ç»“æ„ä½“æ˜¯12byteå¤§å°æ—¶ï¼Œä¸ä¸€å®šèƒ½ä¿è¯64ä½å¯¹é½ tinyallocé—®é¢˜**
    


